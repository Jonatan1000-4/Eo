<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TV | Canales</title>

<style>
:root{
  --bg:#f3f0e8;
  --card:#ffffff;
  --line:#e6dfcf;
  --text:#1b1b1b;
  --muted:#6b6b6b;
  --accent:#b6db44;
  --radius:18px;
  --focus:#1a73e8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

/* TOP BAR */
.topbar{
  position:sticky;
  top:0;
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px;
  background:rgba(243,240,232,.95);
  border-bottom:1px solid rgba(0,0,0,.05);
  z-index:20;
}
.title{
  font-weight:800;
  font-size:18px;
}
.selectCat{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.1);
  background:#fff;
  font-weight:700;
  outline:none;
}
.search{
  margin-left:auto;
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.1);
  outline:none;
  width:min(320px, 45vw);
}

/* GRID */
.wrap{padding:20px 18px 90px;}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:16px;
}
.card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:14px;
  cursor:pointer;
  transition:.15s;
  outline:none;
  user-select:none;
}
.card:focus{
  border:2px solid var(--focus);
  transform:scale(1.04);
}
.logo{
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:10px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
}
.logo img{
  max-height:48px;
  max-width:100%;
  object-fit:contain;
}
.name{
  font-weight:800;
  font-size:14px;
  line-height:1.2;
}
.group{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Responsive TV */
@media (min-width:1000px){
  .grid{
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  }
  .card{padding:18px;}
}

/* Small toast */
.toast{
  position:fixed;
  left:50%;
  bottom:22px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  font-size:12px;
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
  z-index:50;
}
.toast.show{opacity:1}
</style>
</head>

<body>

<header class="topbar">
  <div class="title">Canales</div>

  <!-- ✅ Por defecto muestra TODOS -->
  <select id="categorySelect" class="selectCat" aria-label="Categoría">
    <option value="ALL">Todas las categorías</option>
  </select>

  <input type="text" id="search" class="search" placeholder="Buscar..." autocomplete="off" />
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<div class="toast" id="toast"></div>

<script type="module">
/* ===== FIREBASE ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"
};

const ALLOWLIST_COLLECTION = "allowlist";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== M3U ===== */
const M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
const M3U_TEXT = ""; // si no está vacío, se usa este y NO se fetchea URL

let ALL_CHANNELS = [];
let CURRENT_CATEGORY = "ALL";

/* ===== UTIL ===== */
const $ = (id) => document.getElementById(id);
const toast = (t) => {
  const el = $("toast");
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(() => el.classList.remove("show"), 1200);
};

async function isAllowlisted(uid){
  const ref = doc(db, ALLOWLIST_COLLECTION, uid);
  const snap = await getDoc(ref);
  return snap.exists() && snap.data()?.enabled === true;
}

/* ===== AUTH GATE ===== */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    location.href = "login.html";
    return;
  }
  try{
    const ok = await isAllowlisted(user.uid);
    if(!ok){
      await signOut(auth);
      location.href = "login.html";
      return;
    }
    boot();
  }catch(e){
    console.error(e);
    toast("Error de acceso");
    await signOut(auth);
    location.href = "login.html";
  }
});

/* ===== PARSER M3U ===== */
function parseM3U(text){
  const lines = text.split(/\r?\n/).map(l => l.trim());
  let current = null;
  const out = [];

  for(const line of lines){
    if(!line) continue;

    if(line.startsWith("#EXTINF")){
      const name = line.split(",").slice(1).join(",").trim() || "Canal";
      const attrs = {};
      const re = /(\w+(?:-\w+)*)="([^"]*)"/g;
      let m;
      while((m = re.exec(line)) !== null){
        attrs[m[1]] = m[2];
      }
      current = {
        id: attrs["tvg-id"] || name,
        epgId: attrs["tvg-id"] || "",
        name,
        logo: attrs["tvg-logo"] || "",
        group: attrs["group-title"] || "Otros",
        url: ""
      };
    } else if(!line.startsWith("#") && current){
      current.url = line;
      out.push(current);
      current = null;
    }
  }
  return out;
}

async function loadChannels(){
  let text = M3U_TEXT;
  if(!text){
    const res = await fetch(M3U_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("No se pudo cargar M3U");
    text = await res.text();
  }
  return parseM3U(text);
}

/* ===== CATEGORÍAS ===== */
function populateCategories(){
  const select = $("categorySelect");
  // reset (mantener primera opción ALL)
  select.innerHTML = `<option value="ALL">Todas las categorías</option>`;

  const groups = [...new Set(ALL_CHANNELS.map(c => c.group || "Otros"))].sort((a,b)=>a.localeCompare(b));
  groups.forEach(g=>{
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    select.appendChild(opt);
  });
}

/* ===== RENDER ===== */
function renderChannels(){
  const grid = $("grid");
  grid.innerHTML = "";

  const searchTerm = $("search").value.trim().toLowerCase();

  // ✅ IMPORTANTE: por defecto muestra TODOS, solo filtra si elegís una categoría
  const list = ALL_CHANNELS.filter(c=>{
    const matchCat = (CURRENT_CATEGORY === "ALL") || (c.group === CURRENT_CATEGORY);
    const matchSearch = !searchTerm || (c.name || "").toLowerCase().includes(searchTerm);
    return matchCat && matchSearch;
  });

  if(!list.length){
    grid.innerHTML = `<div style="grid-column:1/-1; padding:12px; color:rgba(0,0,0,.55); font-weight:700;">
      No hay resultados.
    </div>`;
    return;
  }

  list.forEach((c, index)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.tabIndex = 0; // ✅ control remoto

    card.innerHTML = `
      <div class="logo">
        ${c.logo ? `<img src="${escapeHtml(c.logo)}" alt="">` : `<span style="opacity:.55;font-weight:900;">TV</span>`}
      </div>
      <div class="name">${escapeHtml(c.name)}</div>
      <div class="group">${escapeHtml(c.group || "Otros")}</div>
    `;

    // click (móvil)
    card.addEventListener("click", ()=> playChannel(c, list));

    // enter/ok (TV)
    card.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === "OK" || e.keyCode === 13){
        e.preventDefault();
        playChannel(c, list);
      }
    });

    grid.appendChild(card);

    // autofocus primera card
    if(index === 0) setTimeout(()=>card.focus(), 150);
  });
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

/* ===== PLAY (COMPATIBLE CON ANDROID “url + channels”) ===== */
function playChannel(selected, list){
  // ✅ Formato que tu Player Android dijo que espera:
  // { url: "...", channels: [ { name, url }, ... ] }
  const payload = {
    url: selected?.url || "",
    channels: (list || []).map(ch => ({ name: ch.name, url: ch.url })),

    // (opcional) dejamos el extra por si luego lo usás en Android
    selected,
    playlist: list
  };

  if(window.AndroidBridge && typeof AndroidBridge.playChannel === "function"){
    AndroidBridge.playChannel(JSON.stringify(payload));
    return;
  }

  console.log("AndroidBridge no disponible. Payload:", payload);
  toast("Play (modo prueba)");
}

/* ===== BOOT ===== */
async function boot(){
  try{
    toast("Cargando...");
    ALL_CHANNELS = await loadChannels();
    if(!ALL_CHANNELS.length){
      toast("M3U vacía");
      return;
    }

    CURRENT_CATEGORY = "ALL"; // ✅ siempre iniciar mostrando todo
    populateCategories();
    renderChannels();

    $("search").addEventListener("input", renderChannels);
    $("categorySelect").addEventListener("change", (e)=>{
      CURRENT_CATEGORY = e.target.value;
      renderChannels();
    });

    toast("Listo");
  }catch(e){
    console.error(e);
    toast("Error cargando canales");
  }
}
</script>

</body>
</html>
