<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TV | Canales</title>

<style>
:root{
  --bg:#f3f0e8;
  --card:#ffffff;
  --line:#e6dfcf;
  --text:#1b1b1b;
  --muted:#6b6b6b;
  --accent:#b6db44;
  --radius:14px;
  --focus:#1a73e8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

/* TOP BAR */
.topbar{
  position:sticky;
  top:0;
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  background:#f3f0e8;
  border-bottom:1px solid rgba(0,0,0,.05);
  z-index:20;
}
.title{
  font-weight:800;
  font-size:16px;
}
.selectCat,.search{
  padding:6px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.1);
  background:#fff;
  font-weight:600;
  outline:none;
}
.search{
  margin-left:auto;
  width:220px;
}

/* GRID */
.wrap{padding:14px;}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:12px;
}
.card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:10px;
  cursor:pointer;
  transition:.15s;
  outline:none;
}
.card:focus{
  border:2px solid var(--focus);
  transform:scale(1.05);
}
.logo{
  height:46px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:6px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.06);
  background:#fff;
}
.logo img{
  max-height:34px;     /* ✅ más compacto */
  max-width:88%;
  object-fit:contain;
}
.name{
  font-weight:800;
  font-size:13px;
  line-height:1.2;
}
.group{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:8px 12px;
  border-radius:10px;
  font-size:11px;
  opacity:0;
  pointer-events:none;
  transition:.2s;
}
.toast.show{opacity:1}
</style>
</head>

<body>

<header class="topbar">
  <div class="title">Canales</div>
  <select id="categorySelect" class="selectCat">
    <option value="ALL">Todas</option>
  </select>
  <input id="search" class="search" placeholder="Buscar"/>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<div id="toast" class="toast"></div>

<!-- ✅ FIREBASE COMPAT (funciona en WebView viejo) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ===== CONFIG ===== */
var firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"
};

var ALLOWLIST_COLLECTION = "allowlist";

/* ===== M3U ===== */
var M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
var M3U_TEXT = "";
var JSON_FALLBACK = ""; // opcional: pegá JSON acá si querés

var ALL_CHANNELS = [];
var CURRENT_CATEGORY = "ALL";

/* ===== UTIL ===== */
function $(id){ return document.getElementById(id); }
function toast(t){
  var el = $("toast");
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(function(){ el.classList.remove("show"); }, 1200);
}

/* ===== INIT FIREBASE ===== */
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();

function safeGoToLogin(){
  // ✅ más compatible que location.href a veces en WebView viejo
  window.location.replace("login.html");
}

function safeStayHere(){
  // nada
}

/* ===== ALLOWLIST ===== */
function isAllowlisted(uid){
  return db.collection(ALLOWLIST_COLLECTION).doc(uid).get().then(function(snap){
    return snap.exists && snap.data() && snap.data().enabled === true;
  });
}

/* ===== AUTH GATE ===== */
auth.onAuthStateChanged(function(user){
  if(!user){
    safeGoToLogin();
    return;
  }
  isAllowlisted(user.uid).then(function(ok){
    if(!ok){
      return auth.signOut().then(safeGoToLogin);
    }
    boot();
  }).catch(function(e){
    console.log(e);
    toast("Error de acceso");
    auth.signOut().then(safeGoToLogin);
  });
});

/* ===== PARSER M3U (más tolerante) ===== */
function parseM3U(text){
  // ✅ tolerante: soporta espacios raros y líneas con BOM
  text = (text || "").replace(/^\uFEFF/, "");
  var lines = text.split(/\r?\n/);
  var out = [];
  var name="", logo="", group="", id="";

  for(var i=0;i<lines.length;i++){
    var line = (lines[i] || "").trim();
    if(!line) continue;

    if(line.indexOf("#EXTINF") === 0){
      name = line.split(",").slice(1).join(",").trim() || "Canal";

      // attrs tvg-id/tvg-logo/group-title con regex más permisiva
      var re = /([\w-]+)\s*=\s*"([^"]*)"/g;
      var m;
      while((m = re.exec(line)) !== null){
        var key = m[1];
        var val = m[2];
        if(key === "tvg-logo") logo = val;
        if(key === "group-title") group = val;
        if(key === "tvg-id") id = val;
      }
    } else if(line.charAt(0) !== "#"){
      out.push({
        id: id || name,
        name: name || "Canal",
        logo: logo || "",
        group: group || "Otros",
        url: line
      });
      name=""; logo=""; group=""; id="";
    }
  }
  return out;
}

function loadChannels(){
  if(JSON_FALLBACK){
    try { return Promise.resolve(JSON.parse(JSON_FALLBACK)); }
    catch(e){ console.log(e); }
  }
  if(M3U_TEXT){
    return Promise.resolve(parseM3U(M3U_TEXT));
  }
  return fetch(M3U_URL, { cache: "no-store" })
    .then(function(res){ return res.text(); })
    .then(function(text){ return parseM3U(text); })
    .catch(function(e){ console.log(e); return []; });
}

/* ===== UI ===== */
function populateCategories(){
  var select = $("categorySelect");
  select.innerHTML = '<option value="ALL">Todas</option>';
  var map = {};
  for(var i=0;i<ALL_CHANNELS.length;i++){
    map[ALL_CHANNELS[i].group || "Otros"] = true;
  }
  var groups = Object.keys(map).sort();
  for(var j=0;j<groups.length;j++){
    var opt = document.createElement("option");
    opt.value = groups[j];
    opt.textContent = groups[j];
    select.appendChild(opt);
  }
}

function renderChannels(){
  var grid = $("grid");
  grid.innerHTML = "";

  var search = ($("search").value || "").toLowerCase();

  var list = ALL_CHANNELS.filter(function(c){
    var okCat = (CURRENT_CATEGORY === "ALL") || (c.group === CURRENT_CATEGORY);
    var okSearch = (!search) || (String(c.name||"").toLowerCase().indexOf(search) >= 0);
    return okCat && okSearch;
  });

  if(!list.length){
    grid.innerHTML = '<div style="padding:10px;color:rgba(0,0,0,.55);font-weight:800;">No hay canales</div>';
    return;
  }

  // calcular columnas reales para navegación por flechas
  var cols = getGridCols();

  for(var i=0;i<list.length;i++){
    (function(index){
      var c = list[index];

      var card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;

      card.innerHTML =
        '<div class="logo">' +
          (c.logo ? '<img loading="lazy" src="'+escapeHtml(c.logo)+'" alt="">' : 'TV') +
        '</div>' +
        '<div class="name">'+escapeHtml(c.name)+'</div>' +
        '<div class="group">'+escapeHtml(c.group || "Otros")+'</div>';

      card.onclick = function(){ playChannel(c, list); };

      card.onkeydown = function(e){
        var cards = Array.prototype.slice.call(document.querySelectorAll(".card"));
        var idx = cards.indexOf(card);

        // Enter / OK
        if(e.key === "Enter" || e.keyCode === 13){
          e.preventDefault();
          playChannel(c, list);
          return;
        }

        // Flechas (navegación real)
        if((e.key === "ArrowRight" || e.keyCode === 39) && cards[idx+1]) cards[idx+1].focus();
        if((e.key === "ArrowLeft"  || e.keyCode === 37) && cards[idx-1]) cards[idx-1].focus();
        if((e.key === "ArrowDown"  || e.keyCode === 40) && cards[idx+cols]) cards[idx+cols].focus();
        if((e.key === "ArrowUp"    || e.keyCode === 38) && cards[idx-cols]) cards[idx-cols].focus();
      };

      grid.appendChild(card);

      if(index === 0) setTimeout(function(){ card.focus(); }, 200);
    })(i);
  }
}

function getGridCols(){
  // intenta calcular columnas por ancho real
  try{
    var grid = $("grid");
    var style = window.getComputedStyle(grid);
    var template = style.gridTemplateColumns;
    if(template && template !== "none"){
      return template.split(" ").length || 4;
    }
  }catch(e){}
  return 4; // fallback
}

function escapeHtml(s){
  s = String(s == null ? "" : s);
  return s.replace(/[&<>"']/g, function(c){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[c];
  });
}

/* ===== PLAY (mantiene formato Android url+channels) ===== */
function playChannel(selected, list){
  var payload = {
    url: selected.url,
    channels: list.map(function(c){ return { name: c.name, url: c.url }; })
  };

  if(window.AndroidBridge && typeof AndroidBridge.playChannel === "function"){
    AndroidBridge.playChannel(JSON.stringify(payload));
  }else{
    console.log(payload);
    toast("Play (modo prueba)");
  }
}

/* ===== BOOT ===== */
function boot(){
  toast("Cargando...");
  loadChannels().then(function(chs){
    ALL_CHANNELS = chs || [];
    if(!ALL_CHANNELS.length){
      toast("No hay canales");
      return;
    }
    CURRENT_CATEGORY = "ALL";
    populateCategories();
    renderChannels();

    $("search").addEventListener("input", renderChannels);
    $("categorySelect").addEventListener("change", function(e){
      CURRENT_CATEGORY = e.target.value;
      renderChannels();
    });

    toast("Listo");
  }).catch(function(e){
    console.log(e);
    toast("Error cargando");
  });
}
</script>

</body>
</html>
