<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TV | Canales</title>

<style>
:root{
  --bg:#f3f0e8;
  --card:#ffffff;
  --line:#e6dfcf;
  --text:#1b1b1b;
  --muted:#6b6b6b;
  --accent:#b6db44;
  --radius:14px;
  --focus:#1a73e8;

  --topbar:#f3f0e8;
  --input-bg:#ffffff;
  --shadow: 0 8px 18px rgba(0,0,0,.06);
}

body.dark{
  --bg:#0f1218;
  --card:#141a22;
  --line:rgba(255,255,255,.12);
  --text:#e9eefc;
  --muted:rgba(233,238,252,.65);
  --accent:#66d9ff;
  --focus:#66d9ff;

  --topbar: rgba(15,18,24,.92);
  --input-bg: rgba(255,255,255,.06);
  --shadow: 0 10px 24px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

/* TOP BAR */
.topbar{
  position:sticky;
  top:0;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
  background:var(--topbar);
  border-bottom:1px solid rgba(0,0,0,.05);
  z-index:20;
  backdrop-filter: blur(10px);
}
body.dark .topbar{ border-bottom:1px solid rgba(255,255,255,.08); }

.title{
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
}

.selectCat,.search,.iconBtn{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.1);
  background:var(--input-bg);
  font-weight:700;
  outline:none;
  color:var(--text);
}
body.dark .selectCat,
body.dark .search,
body.dark .iconBtn{
  border:1px solid rgba(255,255,255,.12);
}

.search{
  margin-left:auto;
  width:min(320px, 45vw);
}

.iconBtn{
  width:44px;
  height:38px;
  display:grid;
  place-items:center;
  cursor:pointer;
  user-select:none;
}

/* GRID */
.wrap{padding:14px 14px 24px;}
.grid{
  display:grid; /* ‚úÖ FIX: antes ten√≠as dis:grid */
  grid-template-columns:repeat(auto-fill, minmax(170px, 1fr));
  gap:12px;
  align-items:stretch;
}

/* Cards compactas (logo + texto, no ‚Äúlista gigante‚Äù) */
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px;
  cursor:pointer;
  transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
  outline:none;
  user-select:none;
  box-shadow:var(--shadow);

  display:flex;
  align-items:center;
  gap:10px;
  min-height:76px;
}
.card:focus{
  border-color:var(--focus);
  box-shadow: 0 0 0 2px rgba(26,115,232,.25), var(--shadow);
  transform: translateY(-1px);
}
body.dark .card:focus{
  box-shadow: 0 0 0 2px rgba(102,217,255,.28), var(--shadow);
}

.logo{
  width:56px;
  height:56px;
  flex:0 0 56px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(255,255,255,.7);
  overflow:hidden;
}
body.dark .logo{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.05);
}
.logo img{
  max-height:44px;
  max-width:44px;
  object-fit:contain;
  display:block;
}

.meta{
  min-width:0;
  flex:1;
}
.name{
  font-weight:900;
  font-size:13px;
  line-height:1.15;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.group{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* TV / pantallas grandes */
@media (min-width: 900px){
  .grid{ grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); }
  .card{ min-height:84px; }
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:8px 12px;
  border-radius:10px;
  font-size:11px;
  opacity:0;
  pointer-events:none;
  transition:.2s;
  z-index:50;
}
.toast.show{opacity:1}

@media (prefers-reduced-motion: reduce){
  .card{transition:none}
}
</style>
</head>

<body>

<header class="topbar">
  <div class="title">Canales</div>

  <select id="categorySelect" class="selectCat" aria-label="Categor√≠a">
    <option value="ALL">Todas</option>
  </select>

  <input id="search" class="search" placeholder="Buscar" autocomplete="off"/>

  <button id="btnTheme" class="iconBtn" type="button" title="Modo oscuro">üåô</button>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<div id="toast" class="toast"></div>

<!-- ‚úÖ FIREBASE COMPAT (funciona en WebView viejo) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ===== CONFIG ===== */
var firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"
};

var ALLOWLIST_COLLECTION = "allowlist";

/* ===== M3U ===== */
var M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
var M3U_TEXT = "";
var JSON_FALLBACK = ""; // opcional: peg√° JSON ac√° si quer√©s

var ALL_CHANNELS = [];
var CURRENT_CATEGORY = "ALL";

// ‚úÖ estado UI / navegaci√≥n
var CURRENT_LIST = [];
var ACTIVE_INDEX = 0;
var LAST_FOCUSED_ID = "";

/* ===== UTIL ===== */
function $(id){ return document.getElementById(id); }
function toast(t){
  var el = $("toast");
  if(!el) return;
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(function(){ el.classList.remove("show"); }, 1200);
}

/* ===== THEME (modo oscuro) ===== */
function applyTheme(mode){
  var dark = (mode === "dark");
  document.body.classList.toggle("dark", dark);
  try{ localStorage.setItem("theme", dark ? "dark" : "light"); }catch(e){}
  var btn = $("btnTheme");
  if(btn) btn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
}
function initTheme(){
  var saved = null;
  try{ saved = localStorage.getItem("theme"); }catch(e){}
  if(saved === "dark" || saved === "light"){
    applyTheme(saved);
  }else{
    // default: claro
    applyTheme("light");
  }
}
$("btnTheme").addEventListener("click", function(){
  var isDark = document.body.classList.contains("dark");
  applyTheme(isDark ? "light" : "dark");
});
initTheme();

/* ===== INIT FIREBASE ===== */
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();

function safeGoToLogin(){
  window.location.replace("login.html");
}

/* ===== ALLOWLIST ===== */
function isAllowlisted(uid){
  return db.collection(ALLOWLIST_COLLECTION).doc(uid).get().then(function(snap){
    return snap.exists && snap.data() && snap.data().enabled === true;
  });
}

/* ===== AUTH GATE ===== */
auth.onAuthStateChanged(function(user){
  if(!user){
    safeGoToLogin();
    return;
  }
  isAllowlisted(user.uid).then(function(ok){
    if(!ok){
      return auth.signOut().then(safeGoToLogin);
    }
    boot();
  }).catch(function(e){
    console.log(e);
    toast("Error de acceso");
    auth.signOut().then(safeGoToLogin);
  });
});

/* ===== PARSER M3U (m√°s tolerante) ===== */
function parseM3U(text){
  text = (text || "").replace(/^\uFEFF/, "");
  var lines = text.split(/\r?\n/);
  var out = [];
  var name="", logo="", group="", id="";

  for(var i=0;i<lines.length;i++){
    var line = (lines[i] || "").trim();
    if(!line) continue;

    if(line.indexOf("#EXTINF") === 0){
      name = line.split(",").slice(1).join(",").trim() || "Canal";
      var re = /([\w-]+)\s*=\s*"([^"]*)"/g;
      var m;
      while((m = re.exec(line)) !== null){
        var key = m[1];
        var val = m[2];
        if(key === "tvg-logo") logo = val;
        if(key === "group-title") group = val;
        if(key === "tvg-id") id = val;
      }
    } else if(line.charAt(0) !== "#"){
      out.push({
        id: (id || name || ("ch_"+i)),
        name: (name || "Canal"),
        logo: (logo || ""),
        group: (group || "Otros"),
        url: line
      });
      name=""; logo=""; group=""; id="";
    }
  }
  return out;
}

function loadChannels(){
  if(JSON_FALLBACK){
    try { return Promise.resolve(JSON.parse(JSON_FALLBACK)); }
    catch(e){ console.log(e); }
  }
  if(M3U_TEXT){
    return Promise.resolve(parseM3U(M3U_TEXT));
  }
  return fetch(M3U_URL, { cache: "no-store" })
    .then(function(res){ return res.text(); })
    .then(function(text){ return parseM3U(text); })
    .catch(function(e){ console.log(e); return []; });
}

/* ===== UI ===== */
function populateCategories(){
  var select = $("categorySelect");
  if(!select) return;
  select.innerHTML = '<option value="ALL">Todas</option>';

  var map = {};
  for(var i=0;i<ALL_CHANNELS.length;i++){
    map[ALL_CHANNELS[i].group || "Otros"] = true;
  }
  var groups = Object.keys(map).sort();
  for(var j=0;j<groups.length;j++){
    var opt = document.createElement("option");
    opt.value = groups[j];
    opt.textContent = groups[j];
    select.appendChild(opt);
  }
}

function buildFilteredList(){
  var search = ($("search") && $("search").value ? $("search").value : "").toLowerCase();

  CURRENT_LIST = ALL_CHANNELS.filter(function(c){
    var okCat = (CURRENT_CATEGORY === "ALL") || (c.group === CURRENT_CATEGORY);
    var okSearch = (!search) || (String(c.name||"").toLowerCase().indexOf(search) >= 0);
    return okCat && okSearch;
  });

  if(ACTIVE_INDEX >= CURRENT_LIST.length) ACTIVE_INDEX = Math.max(0, CURRENT_LIST.length - 1);
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;
}

/* ===== NAVEGACI√ìN FLUIDA (control remoto) ===== */
function enableGlobalRemoteNav(){
  if(window.__navEnabled) return;
  window.__navEnabled = true;

  document.addEventListener("keydown", function(e){
    var tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
    if(tag === "input" || tag === "select" || tag === "textarea") return;

    if(!CURRENT_LIST || !CURRENT_LIST.length) return;

    var cols = getGridColsSafe();
    var key = e.key || "";
    var kc = e.keyCode || 0;
    var handled = false;

    function moveTo(newIndex){
      if(newIndex < 0) newIndex = 0;
      if(newIndex > CURRENT_LIST.length - 1) newIndex = CURRENT_LIST.length - 1;
      if(newIndex === ACTIVE_INDEX) return;
      ACTIVE_INDEX = newIndex;
      focusCardByIndex(ACTIVE_INDEX, true);
    }

    // ENTER / OK
    if(key === "Enter" || kc === 13){
      handled = true;
      playChannel(CURRENT_LIST[ACTIVE_INDEX], CURRENT_LIST);
    }

    if(key === "ArrowRight" || kc === 39){ handled = true; moveTo(ACTIVE_INDEX + 1); }
    if(key === "ArrowLeft"  || kc === 37){ handled = true; moveTo(ACTIVE_INDEX - 1); }
    if(key === "ArrowDown"  || kc === 40){ handled = true; moveTo(ACTIVE_INDEX + cols); }
    if(key === "ArrowUp"    || kc === 38){ handled = true; moveTo(ACTIVE_INDEX - cols); }

    if(handled){
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);
}

function renderChannels(){
  buildFilteredList();

  var grid = $("grid");
  if(!grid) return;
  grid.innerHTML = "";

  if(!CURRENT_LIST.length){
    grid.innerHTML = '<div style="padding:10px;color:rgba(0,0,0,.55);font-weight:800;">No hay canales</div>';
    return;
  }

  for(var i=0;i<CURRENT_LIST.length;i++){
    (function(index){
      var c = CURRENT_LIST[index];
      var card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("data-idx", String(index));
      card.setAttribute("data-id", String(c.id || ""));

      card.innerHTML =
        '<div class="logo">' +
          (c.logo
            ? '<img loading="lazy" decoding="async" referrerpolicy="no-referrer" src="'+escapeHtml(c.logo)+'" alt="">'
            : '<span style="opacity:.6;font-weight:900">TV</span>') +
        '</div>' +
        '<div class="meta">' +
          '<div class="name">'+escapeHtml(c.name)+'</div>' +
          '<div class="group">'+escapeHtml(c.group || "Otros")+'</div>' +
        '</div>';

      card.onclick = function(){
        ACTIVE_INDEX = index;
        playChannel(c, CURRENT_LIST);
      };

      card.onfocus = function(){
        ACTIVE_INDEX = index;
        LAST_FOCUSED_ID = String(c.id || "");
      };

      card.onkeydown = function(e){
        if(e.key === "Enter" || e.keyCode === 13){
          e.preventDefault();
          ACTIVE_INDEX = index;
          playChannel(c, CURRENT_LIST);
        }
      };

      grid.appendChild(card);
    })(i);
  }

  var idxToFocus = findIndexById(LAST_FOCUSED_ID);
  if(idxToFocus >= 0) ACTIVE_INDEX = idxToFocus;

  focusCardByIndex(ACTIVE_INDEX, false);
  enableGlobalRemoteNav();
}

function findIndexById(id){
  if(!id) return -1;
  for(var i=0;i<CURRENT_LIST.length;i++){
    if(String(CURRENT_LIST[i].id || "") === id) return i;
  }
  return -1;
}

function focusCardByIndex(index, smooth){
  var grid = $("grid");
  if(!grid) return;
  var el = grid.querySelector('.card[data-idx="'+index+'"]');
  if(!el) return;

  try { el.focus(); } catch(e){}

  try{
    if(typeof el.scrollIntoView === "function"){
      try{
        el.scrollIntoView({ block:"nearest", inline:"nearest", behavior: smooth ? "smooth" : "auto" });
      }catch(e2){
        el.scrollIntoView();
      }
    }
  }catch(e){}
}

function getGridColsSafe(){
  try{
    var grid = $("grid");
    if(!grid) return 4;
    var style = window.getComputedStyle(grid);
    var template = style.gridTemplateColumns;
    if(template && template !== "none"){
      var n = template.split(" ").length;
      return n || 4;
    }
  }catch(e){}
  return 4;
}

function escapeHtml(s){
  s = String(s == null ? "" : s);
  return s.replace(/[&<>"']/g, function(c){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[c];
  });
}

/* ===== PLAY (premium: selectedIndex) ===== */
function playChannel(selected, list){
  var selectedIndex = 0;
  for(var i=0;i<list.length;i++){
    if(list[i].url === selected.url){ selectedIndex = i; break; }
  }

  var payload = {
    url: selected.url,
    channels: list.map(function(c){ return { name: c.name, url: c.url }; }),
    selectedIndex: selectedIndex,
    selected: selected,
    playlist: list
  };

  if(window.AndroidBridge && typeof AndroidBridge.playChannel === "function"){
    window.AndroidBridge.playChannel(JSON.stringify(payload));
  }else{
    console.log(payload);
    toast("Play (modo prueba)");
  }
}

/* ===== BOOT ===== */
function boot(){
  toast("Cargando...");
  loadChannels().then(function(chs){
    ALL_CHANNELS = chs || [];
    if(!ALL_CHANNELS.length){
      toast("No hay canales");
      return;
    }

    CURRENT_CATEGORY = "ALL";
    ACTIVE_INDEX = 0;
    LAST_FOCUSED_ID = "";

    populateCategories();
    renderChannels();

    if($("search")){
      $("search").addEventListener("input", function(){
        ACTIVE_INDEX = 0;
        LAST_FOCUSED_ID = "";
        renderChannels();
      });
    }

    if($("categorySelect")){
      $("categorySelect").addEventListener("change", function(e){
        CURRENT_CATEGORY = e.target.value;
        ACTIVE_INDEX = 0;
        LAST_FOCUSED_ID = "";
        renderChannels();
      });
    }

    toast("Listo");
  }).catch(function(e){
    console.log(e);
    toast("Error cargando");
  });
}
</script>

</body>
</html>
