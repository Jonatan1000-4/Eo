<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso | TV</title>

  <!-- Recomendado: CSP (ajustá si usás otros CDNs/dominos) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          img-src 'self' data: https:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
          connect-src https://www.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com;
        ">

  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#a9b4d6;
      --accent:#5bd6ff;
      --danger:#ff5b7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 20% 20%, rgba(91,214,255,.22), transparent 60%),
                  radial-gradient(900px 500px at 80% 30%, rgba(255,91,122,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      padding:20px;
    }
    .wrap{width:min(440px, 100%);}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    h1{font-size:20px; margin:0 0 6px}
    p{margin:0 0 14px; color:var(--muted); font-size:13px; line-height:1.35}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input:focus{border-color:rgba(91,214,255,.55)}
    .row{display:flex; gap:10px; margin-top:14px}
    button{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid transparent;
      background: linear-gradient(180deg, rgba(91,214,255,.95), rgba(91,214,255,.75));
      color:#06101c;
      font-weight:700;
      cursor:pointer;
    }
    button.secondary{
      background:transparent;
      color:var(--text);
      border-color:var(--line);
    }
    .msg{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      min-height:18px;
    }
    .msg.err{color:var(--danger)}
    .foot{margin-top:10px; font-size:11px; color:rgba(255,255,255,.55)}
    .hint{margin-top:10px; font-size:11px; color:rgba(255,255,255,.55)}
    code{background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px; border:1px solid var(--line)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Acceso privado</h1>
      <p>Ingresá con tu cuenta autorizada. Si no estás habilitado, la app no te deja entrar.</p>

      <label>Email</label>
      <input id="email" type="email" autocomplete="username" placeholder="tuemail@correo.com" />

      <label>Contraseña</label>
      <input id="pass" type="password" autocomplete="current-password" placeholder="••••••••" />

      <div class="row">
        <button id="btnLogin">Entrar</button>
        <button id="btnCreate" class="secondary">Crear</button>
      </div>

      <div id="msg" class="msg"></div>

      <div class="hint">
        Luego del login redirige a <code>app.html</code>.
      </div>
      <div class="foot">Tip: en Android WebView evitá abrir links externos si querés máxima privacidad.</div>
    </div>
  </div>

  <script type="module">
    // ✅ Firebase v9+ (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // 1) PEGÁ ACÁ TU CONFIG (Firebase Console -> Project settings)
    const firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae",
    };

    // 2) RUTAS / COLECCIONES
    const ALLOWLIST_COLLECTION = "allowlist"; // allowlist/{uid} { enabled:true }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const msg = (t, isErr=false) => {
      const el = $("msg");
      el.textContent = t || "";
      el.className = "msg" + (isErr ? " err" : "");
    };

    async function isAllowlisted(uid){
      const ref = doc(db, ALLOWLIST_COLLECTION, uid);
      const snap = await getDoc(ref);
      return snap.exists() && snap.data()?.enabled === true;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      msg("Verificando acceso...");
      try{
        const ok = await isAllowlisted(user.uid);
        if (!ok) {
          msg("Acceso no autorizado (UID no habilitado).", true);
          await auth.signOut();
          return;
        }
        // ✅ OK: entrar al menú
        location.href = "app.html";
      }catch(e){
        msg("Error verificando acceso: " + (e?.message || e), true);
      }
    });

    $("btnLogin").addEventListener("click", async () => {
      msg("");
      const email = $("email").value.trim();
      const pass = $("pass").value;
      if (!email || !pass) return msg("Completa email y contraseña.", true);

      try{
        await signInWithEmailAndPassword(auth, email, pass);
        // redirect se hace en onAuthStateChanged
      }catch(e){
        msg("Login falló: " + (e?.message || e), true);
      }
    });

    $("btnCreate").addEventListener("click", async () => {
      msg("");
      const email = $("email").value.trim();
      const pass = $("pass").value;
      if (!email || !pass) return msg("Completa email y contraseña.", true);

      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        msg("Cuenta creada. Si no estás en allowlist, no podrás entrar.", false);
      }catch(e){
        msg("Crear cuenta falló: " + (e?.message || e), true);
      }
    });
  </script>
</body>
</html>
