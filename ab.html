<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TV con EPG ajustado y progreso</title>
  <style>
    html, body {
      margin:0; padding:0;
      background:#000;
      overflow:hidden;
      height:100%;
      font-family:sans-serif;
    }
    video {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      z-index:0;
      background:#000;
    }
    .capa-negra {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: linear-gradient(0deg, #0b1c2e, #0e243b);
      z-index:5;
      display:block;
    }

    /* === Columna lateral === */
    .canal-overlay {
      position: fixed;
      top: 0px;
      left: 0;
      width: 300px;
      bottom: 0;
      box-shadow: 0 1px 10px rgba(255, 255, 255, 0.159);
      background: linear-gradient(0deg, #0b1c2e, #0e243b);
      padding: 155px 1rem 1rem; /* deja espacio para logo sistema */
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #00aaff79;
      z-index: 10;
      overflow-y: auto;
      transition: transform .3s ease;
    }
    .canal-overlay.oculto { transform:translateX(-100%); }

.logo-sistema1{
  position: absolute;
  top: 0; left: 0;
  width: 280px;
  height: 157px;
  font-family: 'Lucida Sans', Geneva, Verdana, sans-serif;
  background: linear-gradient(0deg, #0b1c2e, #0e243b);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 4rem;
  border-radius: 0;
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  background-image: linear-gradient(10deg, #000000, #5ec1ff, #01487a);
  text-shadow: 0 1PX 40px rgba(54, 181, 245, 0.804);
}

.logo-sistema {
  position: absolute;
  top: 0; left: 0;
  width: 300px;
  height: 147px;
  font-family: 'Lucida Sans', Geneva, Verdana, sans-serif;
  background: linear-gradient(0deg, #0b1c2e, #0e243b);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 2rem;
  border-radius: 0;
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  background-image: linear-gradient(90deg, #000000, #5ec1ff, #01487a);
  text-shadow: 0 1PX 40px rgba(54, 181, 245, 0.804);
}

.canal-overlay h2 {
  color:#ffffff;
  font-size:1.5rem;
  margin-bottom:1rem;
  text-align:center;
}

.canal-overlay button {
  display: block;
  width: 100%;
  padding: 1rem;
  margin: 0.4rem 0;
  background: #1c222b;
  border: 1px solid #2a3a4d;
  color: #a0b3c6;
  text-align: left;
  font-size: 1.1rem;
  text-transform: uppercase;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.canal-overlay button:hover {
  background: #111820;
  border-color: #00aaff;
  color: #ffffff;
}
.canal-overlay button.active {
  background: #0d1117;
  border: 2px solid #00aaff;
  color: #ffffff;
  font-weight: bold;
  box-shadow: 0 0 18px rgba(0, 170, 255, 0.781);
}

/* === Barra superior === */
.barra-info {
  position: fixed;
  top: 0;
  left: 00px;
  right: 0;
  height: 150px;
  background: linear-gradient(0deg, #0b1c2e, #0e243b);
  color: #fff;
  display: none;
  align-items: center;
  gap: 20px;
  box-shadow: 0 1PX 45PX rgba(255, 255, 255, 0.368);
  padding: 0 20px;
  box-sizing: border-box;
  z-index: 920;
}
.barra-info.visible{ display: flex; }

.logo-canal {
  width: 80px;
  height: 80px;
  background: #feffff;
  margin: 0 10px 0 300px;
  border-radius: 6px;
  display: flex;
  box-shadow: 0 1px 25px black;
  align-items: center;
  justify-content: center;
}
.logo-canal img { max-width: 90%; max-height: 90%; object-fit: contain; }

.info-canal {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.canal-nombre {
  font-size: 1.6rem;
  font-family: Verdana, Geneva, Tahoma, sans-serif;
  text-transform: uppercase;
  font-weight: bold;
  margin-bottom: 4px;
}
.programa-actual { font-size: 1.2rem; margin-bottom: 4px; }
.horarios {
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  color: #ccc;
}
.progreso {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
  overflow: hidden;
  margin: 4px 0;
}
.progreso-inner {
  height: 100%;
  width: 0%;
  background: #29f637;
  transition: width 0.5s linear;
}
.siguiente-programa {
  font-size: 0.9rem;
  color: #aaa;
  margin-top: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.hora-fecha {
  text-align: right;
  margin: 0 30px;
  font-size: 1rem;
  min-width: 120px;
}
#hora-actual { font-size: 1.4rem; font-weight: bold; }

.overlay-central {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(0deg, #0b1c2e, #0e243b);
  color: #fff;
  padding: 20px 40px;
  border-radius: 12px;
  text-align: center;
  z-index: 30;
  display: none;
  animation: fadein 0.3s ease;
}
.logo-canal-grande {
  width: 120px;
  height: 100px;
  margin: 0 auto 10px;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}
.logo-canal-grande img { max-width: 100%; max-height: 100%; object-fit: contain; }
.nombre-central {
  font-size: 1.6rem;
  font-weight: bold;
  color: #ffffff;
  text-transform: uppercase;
}
.overlay-numeros {
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(0deg, #0b1c2e, #0e243b);
  color: #ffffff;
  font-size: 3rem;
  font-weight: bold;
  padding: 20px 40px;
  border-radius: 12px;
  z-index: 35;
  display: none;
}

/* === NUEVO: mensaje capa + indicador red === */
#mensaje-capa {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#fff;
  font-size:1.2rem;
  font-family:sans-serif;
  text-align:center;
  display:none;
  z-index:6;
}
#indicador-red {
  position:fixed;
  bottom:5px;
  right:10px;
  background:rgba(0,0,0,0.6);
  color:#0f0;
  padding:4px 8px;
  font-size:0.9rem;
  border-radius:4px;
  font-family:monospace;
  z-index:20;
}
  </style>
</head>
<body>

<video id="tv" autoplay controls></video>
<div class="capa-negra" id="capaNegra"></div>
<div id="mensaje-capa">Recargando…</div>
<div id="indicador-red">Red: --</div>

<div id="canal-overlay" class="canal-overlay">
  <div class="logo-sistema1" >EMTV</div>
  <h2>Canales</h2>
  <div id="canales"></div>
</div>

<div id="barra-info" class="barra-info">
  <div class="logo-sistema">SECURE-TV</div>
  <div class="logo-canal"><img id="logo-actual" src="" alt=""></div>
  <div class="info-canal">
    <div id="nombre-actual" class="canal-nombre">Cargando...</div>
    <div id="programa-actual" class="programa-actual">Programacion no disponible</div>
    <div class="horarios">
      <span id="hora-inicio">--:--</span>
      <span id="hora-fin">--:--</span>
    </div>
    <div class="progreso"><div id="progreso-inner" class="progreso-inner"></div></div>
    <div id="siguiente-programa" class="siguiente-programa">Próximo: --</div>
  </div>
  <div class="hora-fecha">
    <div id="hora-actual">--:--</div>
    <div id="fecha-actual">--/--/----</div>
  </div>
</div>

<div id="overlay-numeros" class="overlay-numeros">0</div>
<div id="overlay-central" class="overlay-central">
  <div class="logo-canal-grande"><img id="logo-central" src="" alt=""></div>
  <div id="nombre-central" class="nombre-central">Canal...</div>
</div>

<script>
  /* === Tu código original completo === */
  var m3uUrl = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
  var epgUrl = "https://jonatan1000-4.github.io/mi_app_rv22/xmltv.xml";
  var canalesDiv = document.getElementById("canales");
  var video = document.getElementById("tv");
  var capaNegra = document.getElementById("capaNegra");
  var overlay = document.getElementById("canal-overlay");
  var nombreActualEl = document.getElementById("nombre-actual");
  var logoActualEl = document.getElementById("logo-actual");
  var programaActualEl = document.getElementById("programa-actual");
  var horaInicioEl = document.getElementById("hora-inicio");
  var horaFinEl = document.getElementById("hora-fin");
  var progresoInner = document.getElementById("progreso-inner");

  var inputBuffer = "";
  var inputTimer = null;
  var listaCanales = [];
  var canalActivoIndex = 0;
  var overlayVisible = true;
  var barraTimeout;
  var epgDoc = null;

  /* === Funciones de lista, epg, teclas, etc. (sin cambios) === */
  // ... (todo tu código original aquí, sin tocar nada) ...
 /* === Cargar M3U === */
  function cargarLista(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", m3uUrl, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) callback(null, xhr.responseText);
    };
    xhr.send();
  }

  function parsearM3U(texto) {
    var lineas = texto.split(/\r?\n/);
    var lista = [];
    for (var i = 0; i < lineas.length; i++) {
      var linea = lineas[i].trim();
      if (linea.indexOf("#EXTINF") === 0) {
        var nombre = linea.split(",").pop().trim();
        var logo = ""; var id = "";
        var matchLogo = /tvg-logo="([^"]*)"/i.exec(linea); if (matchLogo) logo = matchLogo[1];
        var matchId   = /tvg-id="([^"]*)"/i.exec(linea);   if (matchId)   id   = matchId[1];
        var url = (i + 1 < lineas.length) ? lineas[i + 1].trim() : "";
        if (url && url.indexOf("http") === 0) lista.push({ nombre:nombre, url:url, logo:logo, id:id });
      }
    }
    return lista;
  }

  /* === Cargar EPG === */
  function cargarEPG(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", epgUrl, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var parser = new DOMParser();
        epgDoc = parser.parseFromString(xhr.responseText, "application/xml");
        callback();
      }
    };
    xhr.send();
  }

  /* === Parseo fechas XMLTV === */
  function getZoneMinutesFromString(z) {
    if (!z || z.length < 5) return 0;
    var sign = (z.charAt(0) === "-") ? -1 : 1;
    var h = parseInt(z.substr(1,2),10) || 0;
    var m = parseInt(z.substr(3,2),10) || 0;
    return sign * (h*60 + m);
  }

  function parseFechaEPG(str) {
    var partes = str.split(" ");
    var fecha = partes[0];
    var zonaStr = (partes.length > 1) ? partes[1] : "+0000";

    var y  = parseInt(fecha.substr(0,4),10);
    var mo = parseInt(fecha.substr(4,2),10) - 1;
    var d  = parseInt(fecha.substr(6,2),10);
    var h  = parseInt(fecha.substr(8,2),10);
    var mi = parseInt(fecha.substr(10,2),10);
    var s  = parseInt(fecha.substr(12,2),10);

    var fechaUTC = Date.UTC(y, mo, d, h, mi, s);
    if (zonaStr && zonaStr !== "+0000") {
      var zoneMin = getZoneMinutesFromString(zonaStr);
      fechaUTC -= zoneMin * 60000;
    } else {
      var localOffsetMin = new Date().getTimezoneOffset();
      fechaUTC += localOffsetMin * 60000;
    }
    return fechaUTC;
  }

  function formatHora(ts) {
    var d = new Date(ts);
    var h = d.getHours(); if (h<10) h="0"+h;
    var m = d.getMinutes(); if (m<10) m="0"+m;
    return h+":"+m;
  }

  function getProgramaActual(channelId) {
    if (!epgDoc) return null;
    var programas = epgDoc.getElementsByTagName("programme");
    var ahora = new Date().getTime();
    var actual = null, siguiente = null;

    for (var i=0; i<programas.length; i++) {
      var prog = programas[i];
      if (prog.getAttribute("channel") === channelId) {
        var start = prog.getAttribute("start");
        var stop  = prog.getAttribute("stop");
        if (!start || !stop) continue;

        var inicio = parseFechaEPG(start);
        var fin    = parseFechaEPG(stop);

        if (ahora >= inicio && ahora <= fin) {
          var tit = prog.getElementsByTagName("title");
          actual = {
            titulo: (tit && tit.length>0) ? tit[0].textContent : "Sin título",
            inicio: inicio, fin: fin
          };
          if (i+1 < programas.length && programas[i+1].getAttribute("channel") === channelId) {
            var prog2 = programas[i+1];
            var tit2 = prog2.getElementsByTagName("title");
            siguiente = {
              titulo: (tit2 && tit2.length>0) ? tit2[0].textContent : "Sin título",
              inicio: parseFechaEPG(prog2.getAttribute("start")),
              fin: parseFechaEPG(prog2.getAttribute("stop"))
            };
          }
          break;
        }
      }
    }
    return { actual: actual, siguiente: siguiente };
  }

  /* === UI === */
  function mostrarCanales(lista) {
    canalesDiv.innerHTML = "";
    for (var idx=0; idx<lista.length; idx++) (function(idx){
      var canal = lista[idx];
      var btn = document.createElement("button");
      btn.textContent = canal.nombre;
      btn.dataset.index = idx;
      btn.onclick = function() { activarCanal(idx); };
      canalesDiv.appendChild(btn);
    })(idx);
    if (lista.length > 0) { activarCanal(0); }
  }

 // solo marca el foco en lista
function setActivo(idx) {
  canalActivoIndex = idx;
  var botones = canalesDiv.getElementsByTagName("button");
  for (var i = 0; i < botones.length; i++) {
    botones[i].classList.toggle("active", i === idx);
  }
  // scroll lista
  var activo = botones[idx];
  if (activo) {
    var pos = activo.offsetTop - overlay.clientHeight/2;
    if (pos < 0) pos = 0;
    overlay.scrollTop = pos;
  }
}

// activa canal + actualiza barra + reproduce
function activarCanal(idx) {
  setActivo(idx);
  var canal = listaCanales[idx];
  nombreActualEl.textContent = canal.nombre;
  logoActualEl.src = canal.logo || "";

  // EPG
  var progInfo = canal.id ? getProgramaActual(canal.id) : null;
  if (progInfo && progInfo.actual) {
    var prog = progInfo.actual;
    programaActualEl.textContent = prog.titulo;
    horaInicioEl.textContent = formatHora(prog.inicio);
    horaFinEl.textContent = formatHora(prog.fin);
    actualizarProgreso(prog);

    if (progInfo.siguiente) {
      var sig = progInfo.siguiente;
      document.getElementById("siguiente-programa").textContent =
        "Próximo: " + formatHora(sig.inicio) + " - " + sig.titulo;
    } else {
      document.getElementById("siguiente-programa").textContent = "Próximo: --";
    }
  } else {
    programaActualEl.textContent = "Programacion no disponible";
    horaInicioEl.textContent = "00:00";
    horaFinEl.textContent = "00:00";
    progresoInner.style.width = "100%";
    document.getElementById("siguiente-programa").textContent = "Próximo: No disponible ahora.";
  }

  // barra info 15s
  var barra = document.getElementById("barra-info");
  barra.classList.add("visible");
  clearTimeout(barraTimeout);
  barraTimeout = setTimeout(function(){
    barra.classList.remove("visible");
  }, 15000);

  reproducir(canal.url);
}

function actualizarProgreso(prog) {
  var ahora = new Date().getTime();
  var duracion = prog.fin - prog.inicio;
  var transcurrido = ahora - prog.inicio;
  var porcentaje = Math.max(0, Math.min(100, (transcurrido/duracion)*100));
  progresoInner.style.width = porcentaje+"%";
  setTimeout(function(){ actualizarProgreso(prog); }, 60000);
}

function reproducir(url) {
  capaNegra.style.display = "block";
  video.src = url;
  video.play();
}

/* === Navegación === */
function handleKey(e) {
  var keyCode = e.keyCode || e.which;   // 🔹 clave para TV Box viejos
  var key = e.key;

  if (key === "ArrowUp" || keyCode === 38) {
    e.preventDefault();
    if (overlayVisible) moverFocoLista(-1);
    else moverFoco(-1);

  } else if (key === "ArrowDown" || keyCode === 40) {
    e.preventDefault();
    if (overlayVisible) moverFocoLista(1);
    else moverFoco(1);

  } else if (key === "ArrowLeft" || keyCode === 37) {
    e.preventDefault();
    toggleOverlay(false);

  } else if (key === "ArrowRight" || keyCode === 39) {
    e.preventDefault();
    toggleOverlay(true);

  } else if (
    key === "Enter" || key === "OK" || key === "Select" ||
    keyCode === 13 || keyCode === 66 || keyCode === 65376
  ) {
    e.preventDefault();
    activarCanal(canalActivoIndex);   // 🔹 fuerza la reproducción
    if (overlayVisible) toggleOverlay(false);

  } else if ((/^[0-9]$/.test(key)) || (keyCode >= 48 && keyCode <= 57)) {
    var digit = (typeof key === "string" && /^[0-9]$/.test(key))
      ? key
      : String.fromCharCode(keyCode);
    inputBuffer += digit;

    var overlayNum = document.getElementById("overlay-numeros");
    overlayNum.textContent = inputBuffer;
    overlayNum.style.display = "block";

    clearTimeout(inputTimer);
    inputTimer = setTimeout(function () {
      seleccionarPorNumero(inputBuffer);
      inputBuffer = "";
      overlayNum.style.display = "none";
    }, 1500);
  }
}

function moverFoco(dir) {
  var nuevo = canalActivoIndex + dir;
  if (nuevo < 0) nuevo = listaCanales.length - 1;
  if (nuevo >= listaCanales.length) nuevo = 0;
  activarCanal(nuevo);
}

function moverFocoLista(dir) {
  var nuevo = canalActivoIndex + dir;
  if (nuevo < 0) nuevo = listaCanales.length - 1;
  if (nuevo >= listaCanales.length) nuevo = 0;
  setActivo(nuevo); // solo foco, sin reproducir
}

function toggleOverlay(show) {
  overlayVisible = show;
  overlay.classList.toggle("oculto", !show);
}

function seleccionarPorNumero(buffer) {
  var numero = parseInt(buffer, 10) - 1;
  if (numero >= 0 && numero < listaCanales.length) {
    activarCanal(numero);
    mostrarOverlayTemporal(numero);
    toggleOverlay(false); // zapping numérico siempre oculta guía
  }
}


  function mostrarOverlayTemporal(idx) {
    var canal = listaCanales[idx];
    nombreActualEl.textContent = canal.nombre;
    logoActualEl.src = canal.logo || "";

    var barra = document.getElementById("barra-info");
    barra.classList.add("visible");
    clearTimeout(barraTimeout);
    barraTimeout = setTimeout(function(){
      barra.classList.remove("visible");
    }, 15000);

    var overlayCentral = document.getElementById("overlay-central");
    document.getElementById("nombre-central").textContent = canal.nombre;
    if (canal.logo) {
      document.getElementById("logo-central").src = canal.logo;
      document.getElementById("logo-central").style.display = "block";
    } else {
      document.getElementById("logo-central").style.display = "none";
    }
    overlayCentral.style.display = "block";
    setTimeout(function(){ overlayCentral.style.display = "none"; }, 3000);
  }

  /* === Eventos video originales === */
  video.addEventListener("canplay", function() {
    var checkStart = setInterval(function() {
      if (video.duration > 0) {
        clearInterval(checkStart);
        setTimeout(function(){ capaNegra.style.display = "none"; }, 5000);
      }
    }, 300);
  });
  video.addEventListener("pause",   function(){ capaNegra.style.display = "block"; });
  video.addEventListener("stalled", function(){ capaNegra.style.display = "block"; });

  /* === Inicialización === */
  cargarLista(function(err, texto){
    if (!err) { listaCanales = parsearM3U(texto); mostrarCanales(listaCanales); }
  });
  cargarEPG(function(){});
  document.addEventListener("keydown", handleKey);

  function updateReloj() {
    var now = new Date();
    var h = now.getHours(); if (h<10) h="0"+h;
    var m = now.getMinutes(); if (m<10) m="0"+m;
    document.getElementById("hora-actual").textContent = h+":"+m;
    var dias = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
    var meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
    document.getElementById("fecha-actual").textContent =
      dias[now.getDay()] + " " + now.getDate() + " " + meses[now.getMonth()];
  }
  setInterval(updateReloj, 60000);
  updateReloj();

  /* === NUEVO: mensaje capa + indicador red === */
  function mostrarMensajeCapa(texto) {
    var msg = document.getElementById("mensaje-capa");
    msg.textContent = texto;
    msg.style.display = "block";
  }
  function ocultarMensajeCapa() {
    document.getElementById("mensaje-capa").style.display = "none";
  }

  video.addEventListener("waiting", function() {
    capaNegra.style.display = "block";
    mostrarMensajeCapa("Recargando… problemas de red o servidor");
  });
  video.addEventListener("stalled", function() {
    capaNegra.style.display = "block";
    mostrarMensajeCapa("Recargando… problemas de red o servidor");
  });
  video.addEventListener("error", function() {
    capaNegra.style.display = "block";
    mostrarMensajeCapa("Error de señal, intentando reconectar…");
  });
  video.addEventListener("playing", function() {
    capaNegra.style.display = "none";
    ocultarMensajeCapa();
  });

  function medirVelocidad() {
    var start = Date.now();
    fetch("https://speed.hetzner.de/1MB.bin", { cache:"no-store" })
      .then(resp => resp.blob())
      .then(blob => {
        var end = Date.now();
        var duracion = (end - start)/1000;
        var bits = blob.size * 8;
        var velocidad = (bits / duracion) / 1024;
        var texto = velocidad > 1024
          ? (velocidad/1024).toFixed(2) + " Mbps"
          : velocidad.toFixed(0) + " kbps";
        document.getElementById("indicador-red").textContent = "Red: " + texto;
      })
      .catch(()=>{
        document.getElementById("indicador-red").textContent = "Red: sin datos";
      });
  }
  setInterval(medirVelocidad, 20000);
  medirVelocidad();
</script>
</body>
</html>
