<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV | Canales</title>

  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          img-src 'self' data: https:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
          connect-src https: http: https://www.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com;
        ">

  <style>
    :root{
      --bg:#f3f0e8;
      --card:#ffffff;
      --line:#e6dfcf;
      --text:#1b1b1b;
      --muted:#6b6b6b;
      --accent:#b6db44;
      --shadow: 0 10px 22px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; gap:12px;
      padding:14px 14px;
      background:rgba(243,240,232,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.05);
    }
    .iconBtn{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      cursor:pointer;
      display:grid; place-items:center;
      font-size:18px;
    }
    .title{
      flex:1;
      text-align:center;
      font-weight:700;
      letter-spacing:.2px;
    }
    .drop{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      font-weight:600;
      cursor:pointer;
    }
    .search{
      width:min(320px, 45vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      outline:none;
    }

    /* Grid */
    .wrap{padding:10px 12px 90px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap:14px;
      align-items:stretch;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      cursor:pointer;
      position:relative;
      transition: transform .12s ease, box-shadow .12s ease;
      min-height:126px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .card:hover{transform: translateY(-2px)}
    .logoBox{
      height:64px;
      border-radius:14px;
      border:2px solid #eae3d3;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#fff;
    }
    .logoBox img{max-height:48px; max-width:90%; object-fit:contain}
    .name{
      margin-top:10px;
      font-weight:700;
      font-size:14px;
      line-height:1.2;
    }
    .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dots{
      position:absolute;
      top:10px; right:10px;
      width:28px; height:28px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      display:grid; place-items:center;
      font-weight:900;
      opacity:.85;
    }

    /* Bottom tabs */
    .tabs{
      position:fixed; left:0; right:0; bottom:0;
      display:flex; justify-content:space-around; gap:10px;
      padding:10px 12px;
      background:rgba(243,240,232,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(0,0,0,.06);
    }
    .tab{
      flex:1;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      text-align:center;
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      position:relative;
    }
    .tab.active::after{
      content:"";
      position:absolute;
      left:14px; right:14px; bottom:-7px;
      height:6px;
      border-radius:999px;
      background:var(--accent);
      box-shadow: 0 8px 18px rgba(182,219,68,.35);
    }

    /* Small helpers */
    .toast{
      position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
      background:rgba(0,0,0,.82);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body>
  <header class="topbar">
    <button class="iconBtn" id="btnMenu" title="Menú">☰</button>

    <div class="title">
      <span id="catTitle">Nacionales</span>
      <button class="drop" id="btnCat">▼</button>
    </div>

    <input class="search" id="q" placeholder="Buscar canal..." />
    <button class="iconBtn" id="btnLogout" title="Salir">⎋</button>
  </header>

  <main class="wrap">
    <div class="grid" id="grid"></div>
  </main>

  <nav class="tabs">
    <button class="tab active" id="tabTV">TV</button>
    <button class="tab" id="tabMovies">MOVIES</button>
    <button class="tab" id="tabSeries">SERIES</button>
  </nav>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ====== 1) PEGÁ TU CONFIG ======
    const firebaseConfig = {
    apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"

    };

    const ALLOWLIST_COLLECTION = "allowlist";

    // ====== 2) TU M3U (podés usar URL o pegar texto) ======
    // Opción A: URL a tu M3U privado
    const M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
    // Opción B: si querés pegar el texto directamente:
    const M3U_TEXT = ""; // si no está vacío, se usa este y NO se fetchea URL

    // ====== Estado ======
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const toast = (t) => {
      const el = $("toast");
      el.textContent = t;
      el.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(() => el.classList.remove("show"), 1400);
    };

    let ALL_CHANNELS = [];
    let FILTERED = [];
    let CURRENT_GROUP = "Nacionales";

    async function isAllowlisted(uid){
      const ref = doc(db, ALLOWLIST_COLLECTION, uid);
      const snap = await getDoc(ref);
      return snap.exists() && snap.data()?.enabled === true;
    }

    // ====== Auth Gate (si no, vuelve a login) ======
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      try{
        const ok = await isAllowlisted(user.uid);
        if (!ok){
          await signOut(auth);
          location.href = "login.html";
          return;
        }
        await boot();
      }catch(e){
        console.error(e);
        toast("Error de acceso");
        await signOut(auth);
        location.href = "login.html";
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
      location.href = "login.html";
    });

    // ====== M3U parser ======
    function parseM3U(m3uText){
      const lines = m3uText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = [];
      let current = null;

      for (const line of lines){
        if (line.startsWith("#EXTINF")){
          // Ejemplo:
          // #EXTINF:-1 tvg-id="Telefe" tvg-logo="https://..." group-title="Nacionales",Telefe | Argentina
          const name = line.split(",").slice(1).join(",").trim() || "Canal";
          const attrs = {};
          const attrPart = line.split(",")[0];

          const re = /(\w+(?:-\w+)*)="([^"]*)"/g;
          let m;
          while ((m = re.exec(attrPart)) !== null){
            attrs[m[1]] = m[2];
          }
          current = {
            id: attrs["tvg-id"] || name,
            epgId: attrs["tvg-id"] || "",
            logo: attrs["tvg-logo"] || "",
            group: attrs["group-title"] || "Otros",
            name
          };
        } else if (!line.startsWith("#") && current){
          current.url = line;
          out.push(current);
          current = null;
        }
      }
      return out;
    }

    async function loadChannels(){
      let text = M3U_TEXT;
      if (!text){
        if (!M3U_URL || M3U_URL.startsWith("PONER_")){
          throw new Error("Falta configurar M3U_URL o M3U_TEXT");
        }
        const res = await fetch(M3U_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("No se pudo cargar M3U");
        text = await res.text();
      }
      return parseM3U(text);
    }

    // ====== UI Render ======
    function uniqueGroups(chs){
      const set = new Set(chs.map(c => c.group || "Otros"));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function applyFilter(){
      const q = $("q").value.trim().toLowerCase();
      FILTERED = ALL_CHANNELS
        .filter(c => (c.group || "Otros") === CURRENT_GROUP)
        .filter(c => !q || (c.name || "").toLowerCase().includes(q));

      renderGrid(FILTERED);
      $("catTitle").textContent = CURRENT_GROUP;
    }

    function renderGrid(chs){
      const grid = $("grid");
      grid.innerHTML = "";

      for (const c of chs){
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="dots">⋮</div>
          <div class="logoBox">
            ${c.logo ? `<img src="${escapeHtml(c.logo)}" alt="">` : `<span style="opacity:.5;font-weight:800">TV</span>`}
          </div>
          <div>
            <div class="name">${escapeHtml(c.name || "Canal")}</div>
            <div class="sub">${escapeHtml(c.group || "Otros")}</div>
          </div>
        `;
        el.addEventListener("click", () => onPlay(c));
        grid.appendChild(el);
      }
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    // ====== Play (manda a Android) ======
    function onPlay(selected){
      // Payload: selected + playlist (del grupo actual) para lista lateral en ExoPlayer
      const payload = {
        selected,
        playlist: FILTERED.length ? FILTERED : ALL_CHANNELS.filter(c => (c.group||"Otros") === CURRENT_GROUP),
        epg: null // si querés, más adelante le agregás acá tu EPG ya procesado
      };

      // Si estás en WebView Android con JSInterface:
      if (window.AndroidBridge && typeof window.AndroidBridge.playChannel === "function"){
        window.AndroidBridge.playChannel(JSON.stringify(payload));
        return;
      }

      // Si lo abrís en navegador común (testing):
      console.log("AndroidBridge no disponible. Payload:", payload);
      toast("Play (modo prueba)");
    }

    // ====== Category dropdown simple ======
    function openCategoryPicker(groups){
      const pick = prompt("Elegí categoría:\n\n" + groups.join("\n"), CURRENT_GROUP);
      if (!pick) return;
      const normalized = groups.find(g => g.toLowerCase() === pick.toLowerCase());
      if (normalized){
        CURRENT_GROUP = normalized;
        applyFilter();
      } else {
        toast("Categoría no encontrada");
      }
    }

    // ====== Tabs (placeholder) ======
    function setTab(activeId){
      ["tabTV","tabMovies","tabSeries"].forEach(id => $(id).classList.toggle("active", id===activeId));
      if (activeId !== "tabTV") toast("Solo TV por ahora");
    }

    async function boot(){
      toast("Cargando...");
      ALL_CHANNELS = await loadChannels();
      if (!ALL_CHANNELS.length) {
        toast("M3U vacía");
        return;
      }
      const groups = uniqueGroups(ALL_CHANNELS);
      CURRENT_GROUP = groups.includes("Nacionales") ? "Nacionales" : (groups[0] || "Otros");

      $("q").addEventListener("input", applyFilter);
      $("btnCat").addEventListener("click", () => openCategoryPicker(groups));
      $("btnMenu").addEventListener("click", () => openCategoryPicker(groups)); // simple
      $("tabTV").addEventListener("click", () => setTab("tabTV"));
      $("tabMovies").addEventListener("click", () => setTab("tabMovies"));
      $("tabSeries").addEventListener("click", () => setTab("tabSeries"));

      applyFilter();
      toast("Listo");
    }
  </script>
</body>
</html>
