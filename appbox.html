<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>TV | Canales</title>

<style>
:root{
  --bg:#0b1b2d;
  --top:#0a2036;
  --panel:#0f2a44;
  --card:#0e253c;
  --line:rgba(255,255,255,.10);
  --text:#eaf3ff;
  --muted:rgba(234,243,255,.65);

  --accent:#18b6d6;
  --focus:#22c7e6;
  --input:#0b2238;

  --shadow: 0 10px 24px rgba(0,0,0,.35);

  --gap:12px;
  --cardW: 200px;
  --pad: 10px;
  --logoBoxH: 72%;
  --radius:14px;

  --sideW: 170px;
  --sideBtnH: 74px;
  --sidePad: 14px;

  --topH: 62px;
}
body.light{
  --bg:#f2f4f7;
  --top:#0b1b2d;
  --panel:#ffffff;
  --card:#ffffff;
  --line:rgba(0,0,0,.10);
  --text:#0d1726;
  --muted:rgba(13,23,38,.65);
  --accent:#18b6d6;
  --focus:#18b6d6;
  --input:#ffffff;
  --shadow: 0 10px 20px rgba(0,0,0,.10);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 520px at 15% 15%, rgba(24,182,214,.14), transparent 55%),
    radial-gradient(800px 480px at 85% 25%, rgba(24,182,214,.10), transparent 60%),
    var(--bg);
  color:var(--text);
  overflow: hidden; /* ‚úÖ clave: el body NO scrollea */
}

/* TOP BAR */
.topbar{
  position:sticky;
  top:0;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  background: linear-gradient(180deg, rgba(10,32,54,.98), rgba(10,32,54,.92));
  border-bottom:1px solid var(--line);
  z-index:20;
}
.title{
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  gap:10px;
}
.title::before{
  content:"";
  width:10px;
  height:10px;
  border-radius:999px;
  background:var(--accent);
  box-shadow:0 0 0 3px rgba(24,182,214,.18);
}

.search,.btnTheme{
  padding:9px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--input);
  color:var(--text);
  font-weight:800;
  outline:none;
}
.search:focus,.btnTheme:focus{
  border-color: rgba(34,199,230,.75);
  box-shadow: 0 0 0 2px rgba(34,199,230,.22);
}
.search{
  margin-left:auto;
  width:min(280px, 34vw);
  font-weight:700;
}
.btnTheme{
  width:44px;
  height:40px;
  display:inline-block;
  text-align:center;
  cursor:pointer;
  user-select:none;
}

/* LAYOUT */
.mainRow{
  display:flex;
  height: calc(100vh - var(--topH)); /* ‚úÖ altura fija */
  overflow: hidden;                  /* ‚úÖ nada se escapa */
}

/* SIDEBAR (anclado, NO se mueve) */
.sidebar{
  width: var(--sideW);
  flex: 0 0 var(--sideW);
  padding: var(--sidePad);
  border-right: 1px solid var(--line);
  background: linear-gradient(180deg, rgba(10,32,54,.55), rgba(10,32,54,.25));
  height: 100%;
  overflow: hidden;          /* ‚úÖ no scrollea */
  display:flex;              /* ‚úÖ footer abajo */
  flex-direction:column;
}

/* contenedor de botones */
.sideMenu{
  display:flex;
  flex-direction:column;
  gap: 12px;
}

/* BOTONES */
.sideBtn{
  width:100%;
  height: var(--sideBtnH);
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  color: var(--text);
  font-weight: 900;
  letter-spacing: .2px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  cursor:pointer;
  outline:none;
  user-select:none;
  appearance:none;
  -webkit-appearance:none;
  padding:0;
}
.sideBtn:focus{
  border-color: rgba(34,199,230,.85);
  box-shadow: 0 0 0 2px rgba(34,199,230,.22), var(--shadow);
}
.sideBtn.active{
  border-color: rgba(34,199,230,.95);
  background: linear-gradient(180deg, rgba(24,182,214,.20), rgba(24,182,214,.08));
  box-shadow: 0 0 0 2px rgba(34,199,230,.18), var(--shadow);
}

/* FOOTER fijo abajo */
.sideFooter{
  margin-top:auto;
  padding-top: 12px;
  border-top: 1px solid var(--line);
  display:flex;
  flex-direction:column;
  gap:8px;
  font-size:12px;
}
.sideFooter .email{
  font-weight:900;
  opacity:.95;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.sideFooter .days{
  color: var(--muted);
  font-weight:800;
}
.sideFooter .warn{
  display:none;
  padding:10px 10px;
  border-radius:12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255, 184, 0, .12);
  font-weight:900;
}
.sideFooter.warnOn .warn{ display:block; }

/* content: SOLO ac√° scrollea */
.content{
  flex:1;
  padding: 12px;
  overflow:auto; /* ‚úÖ */
  -webkit-overflow-scrolling: touch;
}

/* GRID */
.grid{
  display:flex;
  flex-wrap:wrap;
  margin: calc(var(--gap) * -0.5);
}
.card{
  width: var(--cardW);
  margin: calc(var(--gap) * 0.5);
  background: linear-gradient(180deg, rgba(14,37,60,.98), rgba(12,32,52,.98));
  border:1px solid var(--line);
  border-radius:var(--radius);
  cursor:pointer;
  outline:none;
  user-select:none;
  box-shadow:var(--shadow);
  position:relative;
  transform: translateZ(0);
}
body.light .card{ background: var(--card); }
.card:focus{
  border-color: rgba(34,199,230,.85);
  box-shadow: 0 0 0 2px rgba(34,199,230,.22), var(--shadow);
}
.card::before{ content:""; display:block; padding-top:100%; }
.cardInner{
  position:absolute;
  left: var(--pad);
  right: var(--pad);
  top: var(--pad);
  bottom: var(--pad);
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:0;
}
.logo{
  flex:0 0 auto;
  height: var(--logoBoxH);
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.logo img{ max-width:98%; max-height:98%; object-fit:contain; display:block; }
.meta{
  flex:1;
  min-width:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}
.name{
  font-weight:900;
  font-size:13px;
  line-height:1.15;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.group{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.80);
  color:#fff;
  padding:9px 12px;
  border-radius:12px;
  font-size:11px;
  opacity:0;
  pointer-events:none;
  transition:.2s;
  z-index:50;
}
.toast.show{opacity:1}

@media (max-width: 700px){
  :root{ --cardW: 46vw; --sideW: 140px; }
  .search{ width: 45vw; }
}
</style>
</head>

<body>

<header class="topbar">
  <div class="title" id="pageTitle">Contenido</div>
  <input id="search" class="search" placeholder="Buscar" autocomplete="off" tabindex="0"/>
  <button id="btnTheme" class="btnTheme" type="button" title="Tema" tabindex="0">‚òÄÔ∏è</button>
</header>

<div class="mainRow">
  <aside class="sidebar" aria-label="Secciones" id="sidebar">

    <div class="sideMenu" id="sideMenu">
      <button class="sideBtn active" type="button" tabindex="0" data-cat="tv en vivo">TV en vivo</button>
      <button class="sideBtn" type="button" tabindex="0" data-cat="peliculas">Pel√≠culas</button>
      <button class="sideBtn" type="button" tabindex="0" data-cat="series">Series</button>
      <button class="sideBtn" type="button" tabindex="0" data-cat="radios">Radios</button>
    </div>

    <div class="sideFooter" id="sideFooter">
      <div class="email" id="userEmail">‚Äî</div>
      <div class="days" id="daysLeft">‚Äî</div>
      <div class="warn" id="renewWarn">Renov√° tu suscripci√≥n. Quedan pocos d√≠as de servicio.</div>
    </div>

  </aside>

  <main class="content">
    <div class="grid" id="grid"></div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ===== CONFIG ===== */
var firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"
};

var ALLOWLIST_COLLECTION = "allowlist";
var M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
var M3U_TEXT = "";
var JSON_FALLBACK = "";

/* ===== STATE ===== */
var ALL_CHANNELS = [];
var CURRENT_LIST = [];
var ACTIVE_INDEX = 0;
var CURRENT_CATEGORY = "tv en vivo";

/* ===== SERIES SUBMEN√ö ===== */
var SERIES_MODE = "FLAT"; // "FLAT" | "SERIES" | "SEASONS" | "EPISODES"
var SERIES_INDEX = null;
var SERIES_KEYS = [];
var ACTIVE_SERIES_KEY = "";
var ACTIVE_SEASON_KEY = "";
var SERIES_LIST = [];
var SEASONS_LIST = [];
var EPISODES_LIST = [];

/* ===== KEYCODES TV ===== */
var KC = {
  LEFT: 37, UP: 38, RIGHT: 39, DOWN: 40, ENTER: 13,
  DPAD_LEFT: 21, DPAD_UP: 19, DPAD_RIGHT: 22, DPAD_DOWN: 20, DPAD_CENTER: 23,
  BACK: 4, ESC: 27
};
function isLeft(k, c){ return k==="ArrowLeft" || c===KC.LEFT || c===KC.DPAD_LEFT; }
function isRight(k, c){ return k==="ArrowRight" || c===KC.RIGHT || c===KC.DPAD_RIGHT; }
function isUp(k, c){ return k==="ArrowUp" || c===KC.UP || c===KC.DPAD_UP; }
function isDown(k, c){ return k==="ArrowDown" || c===KC.DOWN || c===KC.DPAD_DOWN; }
function isOk(k, c){ return k==="Enter" || c===KC.ENTER || c===KC.DPAD_CENTER; }
function isBack(k, c){ return k==="Escape" || c===KC.ESC || c===KC.BACK; }

/* ===== UTIL ===== */
function $(id){ return document.getElementById(id); }

function toast(t){
  var el = $("toast");
  if(!el) return;
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(function(){ el.classList.remove("show"); }, 1200);
}

function escapeHtml(s){
  s = String(s == null ? "" : s);
  return s.replace(/[&<>"']/g, function(c){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[c];
  });
}

function norm(s){
  s = String(s || "");
  try{ s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }catch(e){}
  return s.trim().toLowerCase();
}

/* ‚úÖ padStart killer (Android TV viejo) */
function pad2(n){
  n = parseInt(n, 10) || 0;
  return (n < 10 ? "0" : "") + n;
}

/* t√≠tulo ‚Äúlimpio‚Äù para agrupar mejor (sin SxxExx, 3x08, etc.) */
function cleanSeriesTitle(t){
  t = String(t || "").replace(/[_\-|]+/g, " ").replace(/\s+/g, " ").trim();
  t = t.replace(/\b(1080p|720p|480p|4k|uhd|hdr|latino|castellano|espanol|sub|subs)\b/ig, "").trim();
  t = t.replace(/\s+/g, " ").trim();
  return t;
}

function catKeyFromGroup(group){
  var g = norm(group);
  if(g.indexOf("tv") >= 0 && g.indexOf("vivo") >= 0) return "tv en vivo";
  if(g.indexOf("pel") >= 0) return "peliculas";
  if(g.indexOf("seri") >= 0) return "series";
  if(g.indexOf("radio") >= 0) return "radios";
  return "";
}

/* ===== SERIES META (m√°s tolerante) ===== */
function parseSeriesMetaFromText(raw){
  var s = String(raw || "").trim();
  if(!s) return { title:"", season:0, episode:0 };

  var clean = cleanSeriesTitle(s);

  var mTxt = clean.match(/^(.*?)[\s\-:]*(temporada|season|temp|t)\s*(\d{1,2})[\s\-:]*(episodio|episode|ep|e)\s*(\d{1,3})\b/i);
  if(mTxt){
    var titleT = cleanSeriesTitle((mTxt[1] || "").trim());
    return { title:titleT, season:parseInt(mTxt[3],10)||0, episode:parseInt(mTxt[5],10)||0 };
  }

  var m = clean.match(/^(.*?)[\s\-:]*[ST]\s*(\d{1,2})\s*[\s\-:]*E\s*(\d{1,3})\b/i);
  if(m){
    var title = cleanSeriesTitle((m[1] || "").trim());
    return { title:title, season:parseInt(m[2],10)||0, episode:parseInt(m[3],10)||0 };
  }

  var mA = clean.match(/^(.*?)[\s\-:]*[ST]\s*(\d{1,2})\s*E\s*(\d{1,3})\b/i);
  if(mA){
    var titleA = cleanSeriesTitle((mA[1] || "").trim());
    return { title:titleA, season:parseInt(mA[2],10)||0, episode:parseInt(mA[3],10)||0 };
  }

  var m2 = clean.match(/^(.*?)[\s\-:]*([0-9]{1,2})\s*x\s*([0-9]{1,3})\b/i);
  if(m2){
    var title2 = cleanSeriesTitle((m2[1] || "").trim());
    return { title:title2, season:parseInt(m2[2],10)||0, episode:parseInt(m2[3],10)||0 };
  }

  return { title: cleanSeriesTitle(clean), season:0, episode:0 };
}

/* ===== THEME ===== */
function applyTheme(mode){
  var dark = (mode === "dark");
  document.body.classList.toggle("dark", dark);
  document.body.classList.toggle("light", !dark);
  try{ localStorage.setItem("theme", dark ? "dark" : "light"); }catch(e){}
  var b = $("btnTheme");
  if(b) b.textContent = dark ? "‚òÄÔ∏è" : "üåô";
}
function initTheme(){
  var saved = null;
  try{ saved = localStorage.getItem("theme"); }catch(e){}
  if(saved === "dark" || saved === "light") applyTheme(saved);
  else applyTheme("dark");
}
if($("btnTheme")){
  $("btnTheme").onclick = function(){
    applyTheme(document.body.classList.contains("dark") ? "light" : "dark");
  };
}
initTheme();

/* ===== FIREBASE INIT ===== */
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();

function safeGoToLogin(){ window.location.replace("login.html"); }

/* ===== SUBS FOOTER (email + d√≠as restantes) ===== */
function tsToMs(x){
  if(!x) return 0;
  try{ if(typeof x.toDate === "function") return x.toDate().getTime(); }catch(e){}
  if(x instanceof Date) return x.getTime();
  if(typeof x === "number") return x;
  return 0;
}
function ceilDaysLeft(msLeft){
  var day = 24*60*60*1000;
  return Math.max(0, Math.ceil(msLeft / day));
}
function renderSubscriptionFooter(email, expiresAtMs){
  var emailEl = $("userEmail");
  var daysEl  = $("daysLeft");
  var footer  = $("sideFooter");
  var warnEl  = $("renewWarn");

  if(emailEl) emailEl.textContent = email || "‚Äî";

  if(!expiresAtMs){
    if(daysEl) daysEl.textContent = "D√≠as restantes: ‚Äî";
    if(footer) footer.classList.remove("warnOn");
    return;
  }

  var now = Date.now();
  var days = ceilDaysLeft(expiresAtMs - now);

  if(daysEl) daysEl.textContent = "D√≠as restantes: " + days;

  if(footer){
    footer.classList.toggle("warnOn", days <= 3);
  }
  if(warnEl && days <= 3){
    warnEl.textContent = "Renov√° tu suscripci√≥n. Quedan " + days + " d√≠a" + (days===1?"":"s") + " de servicio.";
  }
}
function loadSubscriptionInfo(uid, fallbackEmail){
  return db.collection(ALLOWLIST_COLLECTION).doc(uid).get().then(function(snap){
    var data = snap.exists ? (snap.data() || {}) : {};
    var enabled = (data.enabled === true);
    if(!enabled) return { ok:false };

    var expiresAtMs = tsToMs(data.expiresAt);

    if(!expiresAtMs){
      var startMs = tsToMs(data.startAt) || tsToMs(data.createdAt);
      if(startMs){
        expiresAtMs = startMs + (30 * 24*60*60*1000);
      }
    }

    return {
      ok: true,
      email: (data.email || fallbackEmail || ""),
      expiresAtMs: expiresAtMs || 0
    };
  });
}

auth.onAuthStateChanged(function(user){
  if(!user){ safeGoToLogin(); return; }

  loadSubscriptionInfo(user.uid, user.email).then(function(info){
    if(!info.ok){
      return auth.signOut().then(safeGoToLogin);
    }

    renderSubscriptionFooter(info.email, info.expiresAtMs);
    clearInterval(window.__subTimer);
    window.__subTimer = setInterval(function(){
      renderSubscriptionFooter(info.email, info.expiresAtMs);
    }, 30 * 60 * 1000);

    boot();
  }).catch(function(e){
    console.log(e);
    toast("Error de acceso");
    auth.signOut().then(safeGoToLogin);
  });
});

/* ===== PARSER M3U ===== */
function parseM3U(text){
  text = (text || "").replace(/^\uFEFF/, "");
  var lines = text.split(/\r?\n/);
  var out = [];
  var name="", logo="", group="", id="", chno="";

  for(var i=0;i<lines.length;i++){
    var line = (lines[i] || "").trim();
    if(!line) continue;

    if(line.indexOf("#EXTINF") === 0){
      name = line.split(",").slice(1).join(",").trim() || "Canal";
      logo=""; group=""; id=""; chno="";

      var re = /([\w-]+)\s*=\s*"([^"]*)"/g;
      var m;
      while((m = re.exec(line)) !== null){
        var key = m[1], val = m[2];
        if(key === "tvg-logo") logo = val;
        if(key === "group-title") group = val;
        if(key === "tvg-id") id = val;
        if(key === "tvg-chno") chno = val;
      }
    } else if(line.charAt(0) !== "#"){
      var url = String(line).split(",")[0].trim();
      var catKey = catKeyFromGroup(group);

      out.push({
        id: (id || name || ("ch_"+i)),
        name: (name || "Canal"),
        logo: (logo || ""),
        group: (group || "Otros"),
        catKey: catKey,
        number: (chno || ""),
        url: url,
        sMeta: (catKey==="series") ? parseSeriesMetaFromText(name) : null
      });

      name=""; logo=""; group=""; id=""; chno="";
    }
  }
  return out;
}

function loadChannels(){
  if(JSON_FALLBACK){
    try { return Promise.resolve(JSON.parse(JSON_FALLBACK)); }
    catch(e){ console.log(e); }
  }
  if(M3U_TEXT){ return Promise.resolve(parseM3U(M3U_TEXT)); }

  return fetch(M3U_URL, { cache:"no-store" })
    .then(function(res){ return res.text(); })
    .then(function(text){ return parseM3U(text); })
    .catch(function(e){ console.log(e); return []; });
}

/* ===== UI LISTA NORMAL ===== */
function buildFilteredList(){
  var searchEl = $("search");
  var search = (searchEl && searchEl.value ? searchEl.value : "").toLowerCase();

  CURRENT_LIST = ALL_CHANNELS.filter(function(c){
    var okCat = (c.catKey === CURRENT_CATEGORY);
    var okSearch = (!search) || (String(c.name||"").toLowerCase().indexOf(search) >= 0);
    return okCat && okSearch;
  });

  if(ACTIVE_INDEX >= CURRENT_LIST.length) ACTIVE_INDEX = Math.max(0, CURRENT_LIST.length - 1);
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;
}

function getCols(){
  var grid = $("grid");
  if(!grid) return 1;

  var gap = 12;
  try{
    var r = document.documentElement;
    var cssGap = (getComputedStyle(r).getPropertyValue("--gap") || "").trim();
    var g = parseInt(cssGap, 10);
    if(!isNaN(g)) gap = g;
  }catch(e){}

  var gridW = grid.clientWidth || (window.innerWidth || 1024);

  var cardW = 200;
  try{
    var r2 = document.documentElement;
    var cssW = (getComputedStyle(r2).getPropertyValue("--cardW") || "").trim();
    var p = parseInt(cssW, 10);
    if(!isNaN(p)) cardW = p;
  }catch(e){}

  var cols = Math.floor((gridW + gap) / (cardW + gap));
  if(!cols || cols < 1) cols = 1;
  return cols;
}

function focusByIndex(idx){
  var grid = $("grid");
  var el = grid ? grid.querySelector('.card[data-idx="'+idx+'"]') : null;
  if(!el) return;
  try{ el.focus(); }catch(e){}
  try{
    if(el.scrollIntoView){
      try{ el.scrollIntoView({block:"nearest", inline:"nearest"}); }
      catch(e2){ el.scrollIntoView(); }
    }
  }catch(e){}
}

function focusActiveSidebarBtn(){
  var btn = document.querySelector('.sideBtn[data-cat="'+CURRENT_CATEGORY+'"]');
  if(btn){ try{ btn.focus(); }catch(e){} return true; }
  var first = document.querySelector(".sideBtn");
  if(first){ try{ first.focus(); }catch(e){} return true; }
  return false;
}

/* ===== SERIES INDEX (agrupaci√≥n real) ===== */
function buildSeriesIndex(items){
  var idx = {};

  for(var i=0;i<items.length;i++){
    var it = items[i];

    var meta = it.sMeta || parseSeriesMetaFromText(it.name || "");
    var title = cleanSeriesTitle((meta.title || it.name || "Serie")).trim();
    if(!title) title = cleanSeriesTitle(it.name || "Serie");

    var key = norm(title);
    if(!idx[key]){
      idx[key] = { title:title, logo:(it.logo||""), seasons:{} };
    }

    var season = parseInt(meta.season,10) || 0;
    var episode = parseInt(meta.episode,10) || 0;

    var sKey = pad2(season); // "00","01","02"...
    if(!idx[key].seasons[sKey]) idx[key].seasons[sKey] = [];

    idx[key].seasons[sKey].push({
      id: it.id,
      rawName: it.name,
      logo: it.logo || idx[key].logo || "",
      group: it.group,
      number: it.number || "",
      url: it.url,
      _season: season,
      _episode: episode,
      _seriesTitle: title
    });
  }

  Object.keys(idx).forEach(function(k){
    var seasons = idx[k].seasons;
    Object.keys(seasons).forEach(function(sk){
      seasons[sk].sort(function(a,b){
        var ae = a._episode||0, be = b._episode||0;
        if(ae !== be) return ae - be;
        return String(a.rawName||"").localeCompare(String(b.rawName||""));
      });
    });
  });

  return idx;
}

function setSeriesMode(mode){
  SERIES_MODE = mode;
  ACTIVE_INDEX = 0;

  var t = $("pageTitle");
  if(t){
    if(CURRENT_CATEGORY !== "series") t.textContent = "Contenido";
    else if(SERIES_MODE === "SERIES") t.textContent = "Series";
    else if(SERIES_MODE === "SEASONS") t.textContent = "Temporadas";
    else if(SERIES_MODE === "EPISODES") t.textContent = "Episodios";
    else t.textContent = "Series";
  }

  renderChannels();
  setTimeout(function(){ focusByIndex(0); }, 80);
}

function enterSeriesIfNeeded(){
  if(CURRENT_CATEGORY !== "series"){
    SERIES_MODE = "FLAT";
    SERIES_INDEX = null;
    SERIES_KEYS = [];
    ACTIVE_SERIES_KEY = "";
    ACTIVE_SEASON_KEY = "";
    SERIES_LIST = [];
    SEASONS_LIST = [];
    EPISODES_LIST = [];
    return;
  }

  try{
    var seriesItems = ALL_CHANNELS.filter(function(c){ return c.catKey === "series"; });
    SERIES_INDEX = buildSeriesIndex(seriesItems);

    SERIES_KEYS = Object.keys(SERIES_INDEX).sort(function(a,b){
      var A = String(SERIES_INDEX[a].title || "").toLowerCase();
      var B = String(SERIES_INDEX[b].title || "").toLowerCase();
      return A < B ? -1 : (A > B ? 1 : 0);
    });

    if(!SERIES_KEYS.length){
      SERIES_MODE = "SERIES";
      SERIES_LIST = [];
      renderChannels();
      return;
    }

    setSeriesMode("SERIES");
  }catch(e){
    console.log("SERIES ERR:", e);
    toast("Error Series");
    SERIES_MODE = "SERIES";
    SERIES_LIST = [];
    renderChannels();
  }
}

function buildSeriesLists(){
  if(CURRENT_CATEGORY !== "series") return;

  if(SERIES_MODE === "SERIES"){
    SERIES_LIST = SERIES_KEYS.map(function(k){
      var s = SERIES_INDEX[k];
      var total = 0;
      var seasonsCount = 0;
      Object.keys(s.seasons).forEach(function(sk){
        seasonsCount++;
        total += (s.seasons[sk] || []).length;
      });

      return {
        __type: "SERIE",
        __key: k,
        name: s.title,
        logo: s.logo || "",
        group: "Series",
        number: seasonsCount + " temp ‚Ä¢ " + total + " eps",
        url: ""
      };
    });
    return;
  }

  if(SERIES_MODE === "SEASONS"){
    var sObj = SERIES_INDEX[ACTIVE_SERIES_KEY];
    if(!sObj){ SEASONS_LIST = []; return; }

    var seasonKeys = Object.keys(sObj.seasons).sort(function(a,b){
      return (parseInt(a,10)||0) - (parseInt(b,10)||0);
    });

    SEASONS_LIST = seasonKeys.map(function(sk){
      var eps = sObj.seasons[sk] || [];
      var n = parseInt(sk,10) || 0;
      return {
        __type: "SEASON",
        __key: sk,
        name: (n > 0 ? ("Temporada " + n) : "Especiales"),
        logo: sObj.logo || "",
        group: sObj.title,
        number: (eps.length + " eps"),
        url: ""
      };
    });
    return;
  }

  if(SERIES_MODE === "EPISODES"){
    var sObj2 = SERIES_INDEX[ACTIVE_SERIES_KEY];
    var eps2 = (sObj2 && sObj2.seasons[ACTIVE_SEASON_KEY]) ? sObj2.seasons[ACTIVE_SEASON_KEY] : [];

    var seasonNum = parseInt(ACTIVE_SEASON_KEY,10) || 0;
    var groupLabel = sObj2 ? (sObj2.title + (seasonNum>0 ? (" ‚Ä¢ T" + seasonNum) : " ‚Ä¢ Especiales")) : "Series";

    EPISODES_LIST = eps2.map(function(ep, i){
      var eNum = parseInt(ep._episode,10) || 0;
      var label = eNum ? ("E" + pad2(eNum)) : ("E" + pad2(i+1));

      return {
        __type: "EPISODE",
        name: label,
        logo: ep.logo || "",
        group: groupLabel,
        number: "",
        url: ep.url,

        id: ep.id,
        _episode: ep._episode || 0,
        _season: ep._season || 0
      };
    });
  }
}

function getActiveRenderList(){
  if(CURRENT_CATEGORY === "series"){
    buildSeriesLists();
    if(SERIES_MODE === "SERIES") return SERIES_LIST;
    if(SERIES_MODE === "SEASONS") return SEASONS_LIST;
    if(SERIES_MODE === "EPISODES") return EPISODES_LIST;
  }
  return CURRENT_LIST;
}

/* ===== RENDER ===== */
function renderChannels(){
  if(CURRENT_CATEGORY !== "series"){
    buildFilteredList();
  }

  var grid = $("grid");
  if(!grid) return;
  grid.innerHTML = "";

  var list = (CURRENT_CATEGORY === "series") ? getActiveRenderList() : CURRENT_LIST;

  var searchEl = $("search");
  var search = (searchEl && searchEl.value ? searchEl.value : "").toLowerCase();

  if(CURRENT_CATEGORY === "series" && SERIES_MODE === "SERIES" && search){
    list = list.filter(function(x){
      return String(x.name||"").toLowerCase().indexOf(search) >= 0;
    });
  }

  if(!list.length){
    grid.innerHTML = '<div style="padding:10px;font-weight:900;opacity:.8">No hay contenido</div>';
    return;
  }

  if(ACTIVE_INDEX >= list.length) ACTIVE_INDEX = Math.max(0, list.length - 1);
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;

  for(var i=0;i<list.length;i++){
    (function(index){
      var c = list[index];

      var card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("data-idx", String(index));
      card.setAttribute("role", "button");

      var line2 = (c.__type === "SERIE" || c.__type === "SEASON")
        ? (c.number || "")
        : (c.group || "Otros");

      card.innerHTML =
        '<div class="cardInner">' +
          '<div class="logo">' +
            (c.logo
              ? '<img loading="lazy" decoding="async" referrerpolicy="no-referrer" src="'+escapeHtml(c.logo)+'" alt="">' 
              : '<span style="opacity:.75;font-weight:900;color:var(--accent)">TV</span>') +
          '</div>' +
          '<div class="meta">' +
            '<div class="name">'+escapeHtml(c.name)+'</div>' +
            '<div class="group">'+escapeHtml(line2)+'</div>' +
          '</div>' +
        '</div>';

      card.onclick = function(){
        ACTIVE_INDEX = index;
        onSelectCard(c, list);
      };

      card.addEventListener("keydown", function(ev){
        var k = ev.key || "";
        var code = ev.keyCode || 0;
        if(isOk(k, code)){
          ev.preventDefault();
          ACTIVE_INDEX = index;
          onSelectCard(c, list);
        }
      }, true);

      card.onfocus = function(){ ACTIVE_INDEX = index; };
      grid.appendChild(card);
    })(i);
  }

  setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
}

/* ===== SELECT ===== */
function onSelectCard(item, currentList){
  if(CURRENT_CATEGORY === "series"){
    if(item.__type === "SERIE"){
      ACTIVE_SERIES_KEY = item.__key;
      ACTIVE_SEASON_KEY = "";
      setSeriesMode("SEASONS");
      return;
    }
    if(item.__type === "SEASON"){
      ACTIVE_SEASON_KEY = item.__key;
      setSeriesMode("EPISODES");
      return;
    }
    if(item.__type === "EPISODE"){
      var sObj = SERIES_INDEX[ACTIVE_SERIES_KEY];
      var eps = (sObj && sObj.seasons[ACTIVE_SEASON_KEY]) ? sObj.seasons[ACTIVE_SEASON_KEY] : [];

      var list = eps.map(function(ep){
        return {
          name: ep.rawName || ("E" + pad2(ep._episode||0)),
          url: ep.url,
          logo: (ep.logo||""),
          number: (ep.number||"")
        };
      });

      playChannel({ name:item.name, url:item.url, logo:item.logo, number:"", group:item.group||"" }, list);
      return;
    }

    if(item.url) playChannel(item, currentList);
    return;
  }

  playChannel(item, currentList);
}

/* ===== PLAY (NO TOCO) ===== */
function playChannel(selected, list){
  var selectedIndex = 0;
  for(var i=0;i<list.length;i++){
    if(list[i].url === selected.url){ selectedIndex = i; break; }
  }

  var payload = {
    url: selected.url,
    channels: list.map(function(c){
      return { name:c.name, url:c.url, logo:(c.logo||""), number:(c.number||"") };
    }),
    selectedIndex: selectedIndex,
    selectedName: selected.name || "",
    selectedLogo: selected.logo || "",
    selectedGroup: selected.group || "",
    selectedNumber: selected.number || ""
  };

  if(window.AndroidBridge && typeof window.AndroidBridge.playChannel === "function"){
    window.AndroidBridge.playChannel(JSON.stringify(payload));
  }else{
    console.log(payload);
    toast("Play (modo prueba)");
  }
}

/* ===== SIDEBAR ===== */
function setActiveCategory(cat){
  CURRENT_CATEGORY = norm(cat);
  ACTIVE_INDEX = 0;

  SERIES_MODE = "FLAT";
  SERIES_INDEX = null;
  SERIES_KEYS = [];
  ACTIVE_SERIES_KEY = "";
  ACTIVE_SEASON_KEY = "";
  SERIES_LIST = [];
  SEASONS_LIST = [];
  EPISODES_LIST = [];

  var btns = document.querySelectorAll(".sideBtn");
  for(var i=0;i<btns.length;i++){
    btns[i].classList.toggle("active", btns[i].getAttribute("data-cat") === CURRENT_CATEGORY);
  }

  if(CURRENT_CATEGORY === "series"){
    enterSeriesIfNeeded();
    return;
  }

  renderChannels();
  setTimeout(function(){ focusByIndex(0); }, 120);
}

function sidebarButtons(){ return Array.prototype.slice.call(document.querySelectorAll(".sideBtn")); }

function moveSidebarFocus(delta){
  var btns = sidebarButtons();
  if(!btns.length) return;

  var ae = document.activeElement;
  var idx = btns.indexOf(ae);
  if(idx < 0){ focusActiveSidebarBtn(); return; }

  var next = idx + delta;
  if(next < 0) next = 0;
  if(next > btns.length - 1) next = btns.length - 1;

  if(next !== idx){
    try{ btns[next].focus(); }catch(e){}
    /* ‚úÖ no scrollIntoView (sidebar fijo) */
  }
}

function initSidebar(){
  var btns = sidebarButtons();
  for(var i=0;i<btns.length;i++){
    (function(btn){
      btn.onclick = function(){ setActiveCategory(btn.getAttribute("data-cat")); };
      btn.addEventListener("keydown", function(ev){
        var k = ev.key || "";
        var code = ev.keyCode || 0;

        if(isUp(k, code)){ ev.preventDefault(); moveSidebarFocus(-1); return; }
        if(isDown(k, code)){ ev.preventDefault(); moveSidebarFocus(1); return; }

        if(isOk(k, code)){ ev.preventDefault(); setActiveCategory(btn.getAttribute("data-cat")); return; }

        if(isRight(k, code)){
          ev.preventDefault();
          setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 50);
          return;
        }
      }, true);
    })(btns[i]);
  }
}

/* ===== REMOTE NAV ===== */
function enableRemoteNav(){
  if(window.__remoteNav) return;
  window.__remoteNav = true;

  document.addEventListener("keydown", function(e){
    var ae = document.activeElement;
    var tag = (ae && ae.tagName) ? ae.tagName.toLowerCase() : "";
    if(tag === "input" || tag === "textarea") return;

    var kc = e.keyCode || 0;
    var key = e.key || "";
    var cols = getCols();
    var inSidebar = ae && ae.classList && ae.classList.contains("sideBtn");

    if(isBack(key, kc) && CURRENT_CATEGORY === "series"){
      if(SERIES_MODE === "EPISODES"){ e.preventDefault(); setSeriesMode("SEASONS"); return; }
      if(SERIES_MODE === "SEASONS"){ e.preventDefault(); setSeriesMode("SERIES"); return; }
    }

    if(!inSidebar && isLeft(key, kc)){
      var list = (CURRENT_CATEGORY === "series") ? getActiveRenderList() : CURRENT_LIST;
      if(!list.length) return;

      var atFirstCol = (cols <= 1) ? (ACTIVE_INDEX === 0) : ((ACTIVE_INDEX % cols) === 0);
      if(atFirstCol){
        e.preventDefault();
        focusActiveSidebarBtn();
        return;
      }
    }

    if(inSidebar && isRight(key, kc)){
      e.preventDefault();
      setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 50);
      return;
    }

    if(!inSidebar && isOk(key, kc)){
      var list2 = (CURRENT_CATEGORY === "series") ? getActiveRenderList() : CURRENT_LIST;
      if(!list2.length) return;
      e.preventDefault();
      onSelectCard(list2[ACTIVE_INDEX], list2);
      return;
    }

    if(inSidebar) return;

    var list3 = (CURRENT_CATEGORY === "series") ? getActiveRenderList() : CURRENT_LIST;
    if(!list3.length) return;

    var next = ACTIVE_INDEX;
    var handled = true;

    if(isRight(key, kc)) next = ACTIVE_INDEX + 1;
    else if(isLeft(key, kc)) next = ACTIVE_INDEX - 1;
    else if(isDown(key, kc)) next = ACTIVE_INDEX + (cols > 1 ? cols : 1);
    else if(isUp(key, kc)) next = ACTIVE_INDEX - (cols > 1 ? cols : 1);
    else handled = false;

    if(!handled) return;

    if(next < 0) next = 0;
    if(next > list3.length - 1) next = list3.length - 1;

    if(next !== ACTIVE_INDEX){
      e.preventDefault();
      ACTIVE_INDEX = next;
      focusByIndex(ACTIVE_INDEX);
    }
  }, true);
}

/* ===== BOOT ===== */
function boot(){
  toast("Cargando...");
  initSidebar();
  enableRemoteNav();

  loadChannels().then(function(chs){
    ALL_CHANNELS = chs || [];
    if(!ALL_CHANNELS.length){ toast("No hay contenido"); return; }

    var order = ["tv en vivo","peliculas","series","radios"];
    var found = "tv en vivo";
    for(var i=0;i<order.length;i++){
      var has = ALL_CHANNELS.some(function(c){ return c.catKey === order[i]; });
      if(has){ found = order[i]; break; }
    }
    setActiveCategory(found);

    var s = $("search");
    if(s){
      s.addEventListener("input", function(){
        ACTIVE_INDEX = 0;
        renderChannels();
        setTimeout(function(){ focusByIndex(0); }, 80);
      });
    }

    window.addEventListener("resize", function(){
      setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
    });

    toast("Listo");
  }).catch(function(e){
    console.log(e);
    toast("Error cargando");
  });
}
</script>

</body>
</html>
