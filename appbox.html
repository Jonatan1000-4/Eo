<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>TV | Canales</title>

<style>
/* ===== PALETA estilo DIRECTV (imagen) ===== */
:root{
  --bg:#0b1b2d;
  --top:#0a2036;
  --panel:#0f2a44;
  --card:#0e253c;
  --line:rgba(255,255,255,.10);
  --text:#eaf3ff;
  --muted:rgba(234,243,255,.65);

  --accent:#18b6d6;
  --focus:#22c7e6;
  --input:#0b2238;

  --shadow: 0 10px 24px rgba(0,0,0,.35);

  --gap:12px;
  --cardW: 200px;   /* grid: ancho tarjeta */
  --pad: 10px;
  --logoBoxH: 72%;
  --radius:14px;

  /* lista */
  --listH: 74px;    /* alto item lista */
  --listLogo: 48px; /* tama√±o logo en lista */
}

/* modo claro (opcional) */
body.light{
  --bg:#f2f4f7;
  --top:#0b1b2d;
  --panel:#ffffff;
  --card:#ffffff;
  --line:rgba(0,0,0,.10);
  --text:#0d1726;
  --muted:rgba(13,23,38,.65);

  --accent:#18b6d6;
  --focus:#18b6d6;
  --input:#ffffff;

  --shadow: 0 10px 20px rgba(0,0,0,.10);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 520px at 15% 15%, rgba(24,182,214,.14), transparent 55%),
    radial-gradient(800px 480px at 85% 25%, rgba(24,182,214,.10), transparent 60%),
    var(--bg);
  color:var(--text);
}

/* TOP BAR */
.topbar{
  position:sticky;
  top:0;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  background: linear-gradient(180deg, rgba(10,32,54,.98), rgba(10,32,54,.92));
  border-bottom:1px solid var(--line);
  z-index:20;
}

.title{
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  gap:10px;
}
.title::before{
  content:"";
  width:10px;
  height:10px;
  border-radius:999px;
  background:var(--accent);
  box-shadow:0 0 0 3px rgba(24,182,214,.18);
}

.search,.btnTheme,.btnView{
  padding:9px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--input);
  color:var(--text);
  font-weight:800;
  outline:none;
}
.search:focus,.btnTheme:focus,.btnView:focus{
  border-color: rgba(34,199,230,.75);
  box-shadow: 0 0 0 2px rgba(34,199,230,.22);
}

.search{
  margin-left:auto;
  width:min(300px, 40vw);
  font-weight:700;
}

.btnTheme,.btnView{
  height:40px;
  cursor:pointer;
  user-select:none;
}

/* CONTENEDOR */
.wrap{ padding: 12px; }

/* FLEX GRID (compat). No gap: usamos margin en cards */
.grid{
  display:flex;
  flex-wrap:wrap;
  margin: calc(var(--gap) * -0.5);
}

/* ===== GRID CARD CUADRADA ===== */
.card{
  width: var(--cardW);
  margin: calc(var(--gap) * 0.5);

  background: linear-gradient(180deg, rgba(14,37,60,.98), rgba(12,32,52,.98));
  border:1px solid var(--line);
  border-radius:var(--radius);
  cursor:pointer;
  outline:none;
  user-select:none;
  box-shadow:var(--shadow);
  position:relative;
  transform: translateZ(0);
}
body.light .card{ background: var(--card); }

.card:focus{
  border-color: rgba(34,199,230,.85);
  box-shadow: 0 0 0 2px rgba(34,199,230,.22), var(--shadow);
}

/* Truco cuadrado */
.card::before{
  content:"";
  display:block;
  padding-top:100%;
}

/* Contenido interno */
.cardInner{
  position:absolute;
  left: var(--pad);
  right: var(--pad);
  top: var(--pad);
  bottom: var(--pad);
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:0;
}

/* Logo arriba */
.logo{
  flex:0 0 auto;
  height: var(--logoBoxH);
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
body.light .logo{
  border:1px solid rgba(0,0,0,.08);
  background: rgba(0,0,0,.03);
}
.logo img{
  max-width:98%;
  max-height:98%;
  object-fit:contain;
  display:block;
}

/* Texto abajo */
.meta{
  flex:1;
  min-width:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}
.name{
  font-weight:900;
  font-size:13px;
  line-height:1.15;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.group{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ===== MODO LISTA ===== */
body.view-list .grid{
  margin: 0;              /* en lista no hace falta negativo */
  display:block;          /* mejor para tv box viejo */
}

body.view-list .card{
  width: 100%;
  height: var(--listH);
  margin: 0 0 10px 0;
  border-radius: 14px;
}

body.view-list .card::before{ display:none; }

body.view-list .cardInner{
  position:static;
  height:100%;
  padding: 10px 12px;
  flex-direction:row;
  align-items:center;
  gap:12px;
}

body.view-list .logo{
  height: var(--listLogo);
  width: var(--listLogo);
  flex: 0 0 var(--listLogo);
  border-radius: 12px;
}

body.view-list .meta{
  justify-content:center;
}

body.view-list .name{ font-size:15px; }
body.view-list .group{ margin-top:2px; }

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.80);
  color:#fff;
  padding:9px 12px;
  border-radius:12px;
  font-size:11px;
  opacity:0;
  pointer-events:none;
  transition:.2s;
  z-index:50;
}
.toast.show{opacity:1}

/* Responsive */
@media (max-width: 520px){
  :root{ --cardW: 46vw; }
  .search{ width: 45vw; }
}
</style>
</head>

<body>

<header class="topbar">
  <div class="title">Canales</div>

  <input id="search" class="search" placeholder="Buscar" autocomplete="off" tabindex="0"/>

  <button id="btnView" class="btnView" type="button" title="Vista" tabindex="0">LISTA</button>

  <button id="btnTheme" class="btnTheme" type="button" title="Tema" tabindex="0">‚òÄÔ∏è</button>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ===== CONFIG ===== */
var firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"
};

var ALLOWLIST_COLLECTION = "allowlist";
var M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
var M3U_TEXT = "";
var JSON_FALLBACK = "";

/* ===== STATE ===== */
var ALL_CHANNELS = [];
var CURRENT_LIST = [];
var ACTIVE_INDEX = 0;
var LAST_FOCUSED_ID = "";

/* ===== UTIL ===== */
function $(id){ return document.getElementById(id); }

function toast(t){
  var el = $("toast");
  if(!el) return;
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(function(){ el.classList.remove("show"); }, 1200);
}

function escapeHtml(s){
  s = String(s == null ? "" : s);
  return s.replace(/[&<>"']/g, function(c){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[c];
  });
}

/* ===== THEME (default DIRECTV dark) ===== */
function applyTheme(mode){
  var dark = (mode === "dark");
  document.body.classList.toggle("dark", dark);
  document.body.classList.toggle("light", !dark);
  try{ localStorage.setItem("theme", dark ? "dark" : "light"); }catch(e){}
  var b = $("btnTheme");
  if(b) b.textContent = dark ? "‚òÄÔ∏è" : "üåô";
}
function initTheme(){
  var saved = null;
  try{ saved = localStorage.getItem("theme"); }catch(e){}
  if(saved === "dark" || saved === "light") applyTheme(saved);
  else applyTheme("dark");
}
if($("btnTheme")){
  $("btnTheme").onclick = function(){
    applyTheme(document.body.classList.contains("dark") ? "light" : "dark");
  };
}
initTheme();

/* ===== VIEW MODE (GRID/LIST) ===== */
function applyView(mode){
  var list = (mode === "list");
  document.body.classList.toggle("view-list", list);
  try{ localStorage.setItem("view", list ? "list" : "grid"); }catch(e){}
  var b = $("btnView");
  if(b) b.textContent = list ? "GRID" : "LISTA";
  // al cambiar vista, recalculamos foco
  setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
}
function initView(){
  var saved = null;
  try{ saved = localStorage.getItem("view"); }catch(e){}
  if(saved === "list" || saved === "grid") applyView(saved);
  else applyView("grid");
}
if($("btnView")){
  $("btnView").onclick = function(){
    applyView(document.body.classList.contains("view-list") ? "grid" : "list");
  };
}
initView();

/* ===== FIREBASE INIT ===== */
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();

function safeGoToLogin(){
  window.location.replace("login.html");
}

function isAllowlisted(uid){
  return db.collection(ALLOWLIST_COLLECTION).doc(uid).get().then(function(snap){
    return snap.exists && snap.data() && snap.data().enabled === true;
  });
}

auth.onAuthStateChanged(function(user){
  if(!user){ safeGoToLogin(); return; }

  isAllowlisted(user.uid).then(function(ok){
    if(!ok){
      return auth.signOut().then(safeGoToLogin);
    }
    boot();
  }).catch(function(e){
    console.log(e);
    toast("Error de acceso");
    auth.signOut().then(safeGoToLogin);
  });
});

/* ===== PARSER M3U (tolerante) =====
   lee tvg-chno="N" para selecci√≥n por n√∫meros en Android
*/
function parseM3U(text){
  text = (text || "").replace(/^\uFEFF/, "");
  var lines = text.split(/\r?\n/);
  var out = [];
  var name="", logo="", group="", id="", chno="";

  for(var i=0;i<lines.length;i++){
    var line = (lines[i] || "").trim();
    if(!line) continue;

    if(line.indexOf("#EXTINF") === 0){
      name = line.split(",").slice(1).join(",").trim() || "Canal";
      logo=""; group=""; id=""; chno="";

      var re = /([\w-]+)\s*=\s*"([^"]*)"/g;
      var m;
      while((m = re.exec(line)) !== null){
        var key = m[1], val = m[2];
        if(key === "tvg-logo") logo = val;
        if(key === "group-title") group = val;
        if(key === "tvg-id") id = val;
        if(key === "tvg-chno") chno = val;
      }
    } else if(line.charAt(0) !== "#"){
      out.push({
        id: (id || name || ("ch_"+i)),
        name: (name || "Canal"),
        logo: (logo || ""),
        group: (group || "Otros"),
        number: (chno || ""),
        url: line
      });
      name=""; logo=""; group=""; id=""; chno="";
    }
  }
  return out;
}

function loadChannels(){
  if(JSON_FALLBACK){
    try { return Promise.resolve(JSON.parse(JSON_FALLBACK)); }
    catch(e){ console.log(e); }
  }
  if(M3U_TEXT){
    return Promise.resolve(parseM3U(M3U_TEXT));
  }
  return fetch(M3U_URL, { cache:"no-store" })
    .then(function(res){ return res.text(); })
    .then(function(text){ return parseM3U(text); })
    .catch(function(e){ console.log(e); return []; });
}

/* ===== UI ===== */
function buildFilteredList(){
  var searchEl = $("search");
  var search = (searchEl && searchEl.value ? searchEl.value : "").toLowerCase();

  // ‚úÖ SIN CATEGOR√çAS: siempre ALL
  CURRENT_LIST = ALL_CHANNELS.filter(function(c){
    var okSearch = (!search) || (String(c.name||"").toLowerCase().indexOf(search) >= 0);
    return okSearch;
  });

  if(ACTIVE_INDEX >= CURRENT_LIST.length) ACTIVE_INDEX = Math.max(0, CURRENT_LIST.length - 1);
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;
}

/* columnas reales (flex). En LISTA forzamos 1 */
function getCols(){
  if(document.body.classList.contains("view-list")) return 1;

  var grid = $("grid");
  if(!grid) return 1;

  var gap = 12;
  try{
    var r = document.documentElement;
    var cssGap = (getComputedStyle(r).getPropertyValue("--gap") || "").trim();
    var g = parseInt(cssGap, 10);
    if(!isNaN(g)) gap = g;
  }catch(e){}

  var gridW = grid.clientWidth || (window.innerWidth || 1024);

  var cardW = 200;
  try{
    var r2 = document.documentElement;
    var cssW = (getComputedStyle(r2).getPropertyValue("--cardW") || "").trim();
    var p = parseInt(cssW, 10);
    if(!isNaN(p)) cardW = p;
  }catch(e){}

  var cols = Math.floor((gridW + gap) / (cardW + gap));
  if(!cols || cols < 1) cols = 1;
  return cols;
}

function focusByIndex(idx){
  var grid = $("grid");
  var el = grid ? grid.querySelector('.card[data-idx="'+idx+'"]') : null;
  if(!el) return;

  try{ el.focus(); }catch(e){}

  try{
    if(el.scrollIntoView){
      try{ el.scrollIntoView({block:"nearest", inline:"nearest"}); }
      catch(e2){ el.scrollIntoView(); }
    }
  }catch(e){}
}

/* navegaci√≥n GLOBAL estable */
function enableRemoteNav(){
  if(window.__remoteNav) return;
  window.__remoteNav = true;

  document.addEventListener("keydown", function(e){
    var tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
    if(tag === "input" || tag === "select" || tag === "textarea") return;
    if(!CURRENT_LIST.length) return;

    var cols = getCols();
    var kc = e.keyCode || 0;
    var key = e.key || "";

    if(key === "Enter" || kc === 13){
      e.preventDefault();
      playChannel(CURRENT_LIST[ACTIVE_INDEX], CURRENT_LIST);
      return;
    }

    var next = ACTIVE_INDEX;
    var handled = true;

    if(key === "ArrowRight" || kc === 39) next = ACTIVE_INDEX + 1;
    else if(key === "ArrowLeft" || kc === 37) next = ACTIVE_INDEX - 1;
    else if(key === "ArrowDown" || kc === 40) next = ACTIVE_INDEX + (cols > 1 ? cols : 1);
    else if(key === "ArrowUp" || kc === 38) next = ACTIVE_INDEX - (cols > 1 ? cols : 1);
    else handled = false;

    if(!handled) return;

    if(next < 0) next = 0;
    if(next > CURRENT_LIST.length - 1) next = CURRENT_LIST.length - 1;

    if(next !== ACTIVE_INDEX){
      e.preventDefault();
      ACTIVE_INDEX = next;
      focusByIndex(ACTIVE_INDEX);
    }
  }, true);
}

function renderChannels(){
  buildFilteredList();
  var grid = $("grid");
  if(!grid) return;
  grid.innerHTML = "";

  if(!CURRENT_LIST.length){
    grid.innerHTML = '<div style="padding:10px;font-weight:900;opacity:.8">No hay canales</div>';
    return;
  }

  for(var i=0;i<CURRENT_LIST.length;i++){
    (function(index){
      var c = CURRENT_LIST[index];

      var card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("data-idx", String(index));
      card.setAttribute("data-id", String(c.id || ""));

      card.innerHTML =
        '<div class="cardInner">' +
          '<div class="logo">' +
            (c.logo
              ? '<img loading="lazy" decoding="async" referrerpolicy="no-referrer" src="'+escapeHtml(c.logo)+'" alt="">'
              : '<span style="opacity:.75;font-weight:900;color:var(--accent)">TV</span>') +
          '</div>' +
          '<div class="meta">' +
            '<div class="name">'+escapeHtml(c.name)+'</div>' +
            '<div class="group">'+escapeHtml(c.group || "Otros")+'</div>' +
          '</div>' +
        '</div>';

      card.onclick = function(){
        ACTIVE_INDEX = index;
        playChannel(c, CURRENT_LIST);
      };

      card.onfocus = function(){
        ACTIVE_INDEX = index;
        LAST_FOCUSED_ID = String(c.id || "");
      };

      grid.appendChild(card);
    })(i);
  }

  // restaurar foco por ID
  var idx = -1;
  for(var j=0;j<CURRENT_LIST.length;j++){
    if(String(CURRENT_LIST[j].id || "") === LAST_FOCUSED_ID){ idx = j; break; }
  }
  if(idx >= 0) ACTIVE_INDEX = idx;
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;

  setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
  enableRemoteNav();
}

/* PLAY: payload para Android */
function playChannel(selected, list){
  var selectedIndex = 0;
  for(var i=0;i<list.length;i++){
    if(list[i].url === selected.url){ selectedIndex = i; break; }
  }

  var payload = {
    url: selected.url,

    channels: list.map(function(c){
      return {
        name: c.name,
        url: c.url,
        logo: c.logo || "",
        number: c.number || ""
      };
    }),

    selectedIndex: selectedIndex,

    selectedName: selected.name || "",
    selectedLogo: selected.logo || "",
    selectedGroup: selected.group || "",
    selectedNumber: selected.number || ""
  };

  if(window.AndroidBridge && typeof window.AndroidBridge.playChannel === "function"){
    window.AndroidBridge.playChannel(JSON.stringify(payload));
  }else{
    console.log(payload);
    toast("Play (modo prueba)");
  }
}

/* BOOT */
function boot(){
  toast("Cargando...");
  loadChannels().then(function(chs){
    ALL_CHANNELS = chs || [];
    if(!ALL_CHANNELS.length){
      toast("No hay canales");
      return;
    }

    ACTIVE_INDEX = 0;
    LAST_FOCUSED_ID = "";

    renderChannels();

    var s = $("search");
    if(s){
      s.addEventListener("input", function(){
        ACTIVE_INDEX = 0;
        LAST_FOCUSED_ID = "";
        renderChannels();
      });
    }

    window.addEventListener("resize", function(){
      setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
    });

    toast("Listo");
  }).catch(function(e){
    console.log(e);
    toast("Error cargando");
  });
}
</script>

</body>
</html>
