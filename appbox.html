<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>TV | Canales</title>

<style>
:root{
  --bg:#f3f0e8;
  --top:#fab802;
  --card:#ffffff;
  --line:#e6dfcf;
  --text:#1b1b1b;
  --muted:#6b6b6b;
  --accent:#b6db44;
  --radius:14px;
  --focus:#1a73e8;
  --input:#ffffff;
  --shadow: 0 10px 22px rgba(0,0,0,.10);

  --gap:12px;      /* separaci√≥n entre tarjetas */
  --cardW: 180px;  /* ancho tarjeta (cuadrada) */
  --pad: 10px;     /* padding interno */
  --logoBoxH: 62%; /* % de alto interno para logo */
}

body.dark{
  --bg:#0f1218;
  --top: rgba(15,18,24,.92);
  --card:#151b24;
  --line: rgba(255,255,255,.12);
  --text:#e9eefc;
  --muted: rgba(233,238,252,.68);
  --accent:#66d9ff;
  --focus:#66d9ff;
  --input: rgba(255,255,255,.06);
  --shadow: 0 14px 28px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

/* TOP BAR */
.topbar{
  position:sticky;
  top:0;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  background:var(--top);
  border-bottom:1px solid rgba(0,0,0,.05);
  z-index:20;
}
body.dark .topbar{ border-bottom:1px solid rgba(255,255,255,.10); }

.title{
  font-weight:900;
  font-size:16px;
  letter-spacing:.2px;
}

.selectCat,.search,.btnTheme{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.12);
  background:var(--input);
  color:var(--text);
  font-weight:800;
  outline:none;
}
body.dark .selectCat,
body.dark .search,
body.dark .btnTheme{
  border:1px solid rgba(255,255,255,.12);
}

.search{
  margin-left:auto;
  width:min(260px, 34vw);
  font-weight:700;
}

.btnTheme{
  width:44px;
  height:38px;
  display:inline-block;
  text-align:center;
  cursor:pointer;
  user-select:none;
}

/* CONTENEDOR */
.wrap{ padding: 12px; }

/* ‚úÖ FLEX (m√°s compatible). NO usamos gap porque en TV Box viejo falla.
   usamos margin en cards + margin negativo en container. */
.grid{
  display:flex;
  flex-wrap:wrap;
  margin: calc(var(--gap) * -0.5);
}

/* ‚úÖ CARD CUADRADA (sin aspect-ratio, compatible) */
.card{
  width: var(--cardW);
  margin: calc(var(--gap) * 0.5);

  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  cursor:pointer;
  outline:none;
  user-select:none;
  box-shadow:var(--shadow);
  position:relative;

  /* Para que el foco se note bien */
  transform: translateZ(0);
}
.card:focus{
  border-color:var(--focus);
  box-shadow: 0 0 0 2px rgba(26,115,232,.25), var(--shadow);
}
body.dark .card:focus{
  box-shadow: 0 0 0 2px rgba(102,217,255,.28), var(--shadow);
}

/* Truco cuadrado */
.card::before{
  content:"";
  display:block;
  padding-top:100%; /* altura = ancho */
}

/* Contenido interno */
.cardInner{
  position:absolute;
  left: var(--pad);
  right: var(--pad);
  top: var(--pad);
  bottom: var(--pad);
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:0;
}

/* Logo arriba */
.logo{
  flex: 0 0 auto;
  height: var(--logoBoxH);
  border-radius:12px;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(255,255,255,.70);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
body.dark .logo{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.05);
}
.logo img{
  max-width:78%;
  max-height:78%;
  object-fit:contain;
  display:block;
}

/* Texto abajo */
.meta{
  flex:1;
  min-width:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}
.name{
  font-weight:900;
  font-size:13px;
  line-height:1.15;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.group{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:8px 12px;
  border-radius:10px;
  font-size:11px;
  opacity:0;
  pointer-events:none;
  transition:.2s;
  z-index:50;
}
.toast.show{opacity:1}

/* Responsive */
@media (max-width: 520px){
  :root{ --cardW: 46vw; }
  .search{ width: 45vw; }
}
</style>
</head>

<body>

<header class="topbar">
  <div class="title">Canales</div>

  <select id="categorySelect" class="selectCat" aria-label="Categor√≠a" tabindex="0">
    <option value="ALL">Todas</option>
  </select>

  <input id="search" class="search" placeholder="Buscar" autocomplete="off" tabindex="0"/>

  <button id="btnTheme" class="btnTheme" type="button" title="Tema" tabindex="0">üåô</button>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
</main>

<div id="toast" class="toast"></div>

<!-- ‚úÖ Firebase v8 (compat WebView viejo) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ===== CONFIG ===== */
var firebaseConfig = {
  apiKey: "AIzaSyBKSdaRAQTN-Gen0k4WerLu1GvBLKzjZlQ",
  authDomain: "aweme-46b1e.firebaseapp.com",
  projectId: "aweme-46b1e",
  storageBucket: "aweme-46b1e.firebasestorage.app",
  messagingSenderId: "762479825387",
  appId: "1:762479825387:web:8ffb3a629c0eb9f52fc9ae"
};

var ALLOWLIST_COLLECTION = "allowlist";
var M3U_URL = "https://jonatan1000-4.github.io/mi_app_rv22/canales.m3u";
var M3U_TEXT = "";
var JSON_FALLBACK = "";

/* ===== STATE ===== */
var ALL_CHANNELS = [];
var CURRENT_CATEGORY = "ALL";
var CURRENT_LIST = [];
var ACTIVE_INDEX = 0;
var LAST_FOCUSED_ID = "";

/* ===== UTIL ===== */
function $(id){ return document.getElementById(id); }

function toast(t){
  var el = $("toast");
  if(!el) return;
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(function(){ el.classList.remove("show"); }, 1200);
}

function escapeHtml(s){
  s = String(s == null ? "" : s);
  return s.replace(/[&<>"']/g, function(c){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[c];
  });
}

/* ===== THEME ===== */
function applyTheme(mode){
  var dark = (mode === "dark");
  document.body.classList.toggle("dark", dark);
  try{ localStorage.setItem("theme", dark ? "dark" : "light"); }catch(e){}
  $("btnTheme").textContent = dark ? "‚òÄÔ∏è" : "üåô";
}
function initTheme(){
  var saved = null;
  try{ saved = localStorage.getItem("theme"); }catch(e){}
  if(saved === "dark" || saved === "light") applyTheme(saved);
  else applyTheme("light");
}
$("btnTheme").onclick = function(){
  applyTheme(document.body.classList.contains("dark") ? "light" : "dark");
};
initTheme();

/* ===== FIREBASE INIT ===== */
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();

function safeGoToLogin(){
  window.location.replace("login.html");
}

function isAllowlisted(uid){
  return db.collection(ALLOWLIST_COLLECTION).doc(uid).get().then(function(snap){
    return snap.exists && snap.data() && snap.data().enabled === true;
  });
}

auth.onAuthStateChanged(function(user){
  if(!user){ safeGoToLogin(); return; }

  isAllowlisted(user.uid).then(function(ok){
    if(!ok){
      return auth.signOut().then(safeGoToLogin);
    }
    boot();
  }).catch(function(e){
    console.log(e);
    toast("Error de acceso");
    auth.signOut().then(safeGoToLogin);
  });
});

/* ===== PARSER M3U (tolerante) ===== */
function parseM3U(text){
  text = (text || "").replace(/^\uFEFF/, "");
  var lines = text.split(/\r?\n/);
  var out = [];
  var name="", logo="", group="", id="";

  for(var i=0;i<lines.length;i++){
    var line = (lines[i] || "").trim();
    if(!line) continue;

    if(line.indexOf("#EXTINF") === 0){
      name = line.split(",").slice(1).join(",").trim() || "Canal";
      logo=""; group=""; id="";
      var re = /([\w-]+)\s*=\s*"([^"]*)"/g;
      var m;
      while((m = re.exec(line)) !== null){
        var key = m[1], val = m[2];
        if(key === "tvg-logo") logo = val;
        if(key === "group-title") group = val;
        if(key === "tvg-id") id = val;
      }
    } else if(line.charAt(0) !== "#"){
      out.push({
        id: (id || name || ("ch_"+i)),
        name: (name || "Canal"),
        logo: (logo || ""),
        group: (group || "Otros"),
        url: line
      });
      name=""; logo=""; group=""; id="";
    }
  }
  return out;
}

function loadChannels(){
  if(JSON_FALLBACK){
    try { return Promise.resolve(JSON.parse(JSON_FALLBACK)); }
    catch(e){ console.log(e); }
  }
  if(M3U_TEXT){
    return Promise.resolve(parseM3U(M3U_TEXT));
  }
  return fetch(M3U_URL, { cache:"no-store" })
    .then(function(res){ return res.text(); })
    .then(function(text){ return parseM3U(text); })
    .catch(function(e){ console.log(e); return []; });
}

/* ===== UI ===== */
function populateCategories(){
  var select = $("categorySelect");
  select.innerHTML = '<option value="ALL">Todas</option>';

  var map = {};
  for(var i=0;i<ALL_CHANNELS.length;i++){
    map[ALL_CHANNELS[i].group || "Otros"] = true;
  }
  var groups = Object.keys(map).sort();
  for(var j=0;j<groups.length;j++){
    var opt = document.createElement("option");
    opt.value = groups[j];
    opt.textContent = groups[j];
    select.appendChild(opt);
  }
}

function buildFilteredList(){
  var search = ($("search").value || "").toLowerCase();

  CURRENT_LIST = ALL_CHANNELS.filter(function(c){
    var okCat = (CURRENT_CATEGORY === "ALL") || (c.group === CURRENT_CATEGORY);
    var okSearch = (!search) || (String(c.name||"").toLowerCase().indexOf(search) >= 0);
    return okCat && okSearch;
  });

  if(ACTIVE_INDEX >= CURRENT_LIST.length) ACTIVE_INDEX = Math.max(0, CURRENT_LIST.length - 1);
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;
}

/* ‚úÖ columnas reales (flex) por ancho del contenedor / card */
function getCols(){
  var grid = $("grid");
  if(!grid) return 1;

  var gap = 12;
  try{
    var r = document.documentElement;
    var cssGap = (getComputedStyle(r).getPropertyValue("--gap") || "").trim();
    var g = parseInt(cssGap, 10);
    if(!isNaN(g)) gap = g;
  }catch(e){}

  var gridW = grid.clientWidth || (window.innerWidth || 1024);

  var cardW = 180;
  try{
    var r2 = document.documentElement;
    var cssW = (getComputedStyle(r2).getPropertyValue("--cardW") || "").trim();
    var p = parseInt(cssW, 10);
    if(!isNaN(p)) cardW = p;
  }catch(e){}

  var cols = Math.floor((gridW + gap) / (cardW + gap));
  if(!cols || cols < 1) cols = 1;
  return cols;
}

function focusByIndex(idx){
  var grid = $("grid");
  var el = grid ? grid.querySelector('.card[data-idx="'+idx+'"]') : null;
  if(!el) return;

  try{ el.focus(); }catch(e){}

  try{
    if(el.scrollIntoView){
      try{ el.scrollIntoView({block:"nearest", inline:"nearest"}); }
      catch(e2){ el.scrollIntoView(); }
    }
  }catch(e){}
}

/* ‚úÖ navegaci√≥n GLOBAL estable */
function enableRemoteNav(){
  if(window.__remoteNav) return;
  window.__remoteNav = true;

  document.addEventListener("keydown", function(e){
    var tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
    if(tag === "input" || tag === "select" || tag === "textarea") return;

    if(!CURRENT_LIST.length) return;

    var cols = getCols();
    var kc = e.keyCode || 0;
    var key = e.key || "";

    // Enter/OK
    if(key === "Enter" || kc === 13){
      e.preventDefault();
      playChannel(CURRENT_LIST[ACTIVE_INDEX], CURRENT_LIST);
      return;
    }

    var next = ACTIVE_INDEX;
    var handled = true;

    if(key === "ArrowRight" || kc === 39) next = ACTIVE_INDEX + 1;
    else if(key === "ArrowLeft" || kc === 37) next = ACTIVE_INDEX - 1;
    else if(key === "ArrowDown" || kc === 40) next = ACTIVE_INDEX + (cols > 1 ? cols : 1);
    else if(key === "ArrowUp" || kc === 38) next = ACTIVE_INDEX - (cols > 1 ? cols : 1);
    else handled = false;

    if(!handled) return;

    if(next < 0) next = 0;
    if(next > CURRENT_LIST.length - 1) next = CURRENT_LIST.length - 1;

    if(next !== ACTIVE_INDEX){
      e.preventDefault();
      ACTIVE_INDEX = next;
      focusByIndex(ACTIVE_INDEX);
    }
  }, true);
}

function renderChannels(){
  buildFilteredList();

  var grid = $("grid");
  grid.innerHTML = "";

  if(!CURRENT_LIST.length){
    grid.innerHTML = '<div style="padding:10px;font-weight:900;opacity:.7">No hay canales</div>';
    return;
  }

  for(var i=0;i<CURRENT_LIST.length;i++){
    (function(index){
      var c = CURRENT_LIST[index];
      var card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("data-idx", String(index));
      card.setAttribute("data-id", String(c.id || ""));

      card.innerHTML =
        '<div class="cardInner">' +
          '<div class="logo">' +
            (c.logo
              ? '<img loading="lazy" decoding="async" referrerpolicy="no-referrer" src="'+escapeHtml(c.logo)+'" alt="">'
              : '<span style="opacity:.65;font-weight:900">TV</span>') +
          '</div>' +
          '<div class="meta">' +
            '<div class="name">'+escapeHtml(c.name)+'</div>' +
            '<div class="group">'+escapeHtml(c.group || "Otros")+'</div>' +
          '</div>' +
        '</div>';

      card.onclick = function(){
        ACTIVE_INDEX = index;
        playChannel(c, CURRENT_LIST);
      };

      card.onfocus = function(){
        ACTIVE_INDEX = index;
        LAST_FOCUSED_ID = String(c.id || "");
      };

      grid.appendChild(card);
    })(i);
  }

  // restaurar foco por ID
  var idx = -1;
  for(var j=0;j<CURRENT_LIST.length;j++){
    if(String(CURRENT_LIST[j].id || "") === LAST_FOCUSED_ID){ idx = j; break; }
  }
  if(idx >= 0) ACTIVE_INDEX = idx;
  if(ACTIVE_INDEX < 0) ACTIVE_INDEX = 0;

  setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
  enableRemoteNav();
}

/* ===== PLAY (url+channels + selectedIndex) ===== */
function playChannel(selected, list){
  var selectedIndex = 0;
  for(var i=0;i<list.length;i++){
    if(list[i].url === selected.url){ selectedIndex = i; break; }
  }

  var payload = {
    url: selected.url,
    channels: list.map(function(c){ return { name: c.name, url: c.url }; }),
    selectedIndex: selectedIndex
  };

  if(window.AndroidBridge && typeof window.AndroidBridge.playChannel === "function"){
    window.AndroidBridge.playChannel(JSON.stringify(payload));
  }else{
    console.log(payload);
    toast("Play (modo prueba)");
  }
}

/* ===== BOOT ===== */
function boot(){
  toast("Cargando...");
  loadChannels().then(function(chs){
    ALL_CHANNELS = chs || [];
    if(!ALL_CHANNELS.length){
      toast("No hay canales");
      return;
    }

    CURRENT_CATEGORY = "ALL";
    ACTIVE_INDEX = 0;
    LAST_FOCUSED_ID = "";

    populateCategories();
    renderChannels();

    $("search").addEventListener("input", function(){
      ACTIVE_INDEX = 0;
      LAST_FOCUSED_ID = "";
      renderChannels();
    });

    $("categorySelect").addEventListener("change", function(e){
      CURRENT_CATEGORY = e.target.value;
      ACTIVE_INDEX = 0;
      LAST_FOCUSED_ID = "";
      renderChannels();
    });

    window.addEventListener("resize", function(){
      setTimeout(function(){ focusByIndex(ACTIVE_INDEX); }, 80);
    });

    toast("Listo");
  }).catch(function(e){
    console.log(e);
    toast("Error cargando");
  });
}
</script>

</body>
</html>
