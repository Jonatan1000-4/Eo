<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U Parser & Exportador</title>
    <style>
        /* CSS Integrado (Minimalista, Oscuro, Peque√±o) */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --secondary-text: #b0b0b0;
            --accent-color: #00bcd4; /* Cian */
            --input-bg: #333;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.5);
            font-size: 14px; /* Letra peque√±a */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1, h2 {
            color: var(--accent-color);
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        input[type="file"], input[type="text"], button {
            padding: 8px 12px;
            margin-right: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9em;
            box-shadow: 0 1px 3px var(--shadow-color);
            transition: background-color 0.2s;
            width: auto;
        }
        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        button {
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--bg-color);
            font-weight: bold;
            border: none;
        }
        button:hover:not(:disabled) {
            background-color: #0097a7;
        }
        .metadata-box {
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.8em;
        }
        .metadata-box p {
            margin: 5px 0;
        }
        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: var(--input-bg);
            border-radius: 4px;
        }
        .category-item {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: #444;
            color: var(--secondary-text);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .category-item input[type="checkbox"] {
            margin-right: 5px;
        }
        .category-item:hover {
            background-color: #555;
        }
        .channel-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .channel-table th, .channel-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.8em;
            word-break: break-all;
        }
        .channel-table th {
            background-color: #333;
            color: var(--accent-color);
            position: sticky;
            top: 0;
        }
        .channel-table tr:hover {
            background-color: #2a2a2a;
        }
        #loading {
            color: var(--accent-color);
            font-weight: bold;
            margin-top: 15px;
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 12px;
            }
            input[type="file"], input[type="text"], button {
                width: 100%;
                margin: 5px 0;
            }
            .category-list {
                flex-direction: column;
            }
            .channel-table th:nth-child(2), .channel-table td:nth-child(2) {
                display: none; /* Ocultar EPG en m√≥vil */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üì° M3U Load & Export</h1>

    <p>Cargar Archivo M3U o ingresar URL:</p>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
        <input type="file" id="fileInput" accept=".m3u,.m3u8" style="flex-grow: 1;">
        <input type="text" id="urlInput" placeholder="O pegar URL M3U aqu√≠" style="flex-grow: 3;">
        <button onclick="loadM3U()">Cargar</button>
    </div>

    <div id="loading">Cargando y analizando M3U...</div>

    <div id="metadata" class="metadata-box" style="display: none;">
        <h2>üìù Metadatos</h2>
        <p>Canales Totales: <strong id="totalChannels">0</strong></p>
        <p>EPG Incluido: <strong id="epgStatus">No</strong></p>
        <p>Fecha de Expiraci√≥n Estimada: <strong id="expirationDate">N/A</strong></p>
        <p>Idiomas Encontrados: <strong id="languages">N/A</strong></p>
    </div>

    <h2 style="margin-top: 20px;">üóÇÔ∏è Filtrar por Categor√≠a</h2>
    <div id="categoryList" class="category-list">
        <p id="categoryPlaceholder" style="color: var(--secondary-text);">Carga un M3U para ver las categor√≠as.</p>
    </div>

    <h2 style="margin-top: 20px;">üì∫ Canales Seleccionados (<span id="selectedCount">0</span>)</h2>
    <button onclick="exportToSheets()" id="exportBtn" disabled>üì§ Exportar Seleccionados a Google Sheets</button>

    <div style="max-height: 400px; overflow-y: auto;">
        <table id="channelTable" class="channel-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>EPG ID</th>
                    <th>Categor√≠a</th>
                    <th>URL</th>
                </tr>
            </thead>
            <tbody id="channelBody">
                </tbody>
        </table>
    </div>

</div>

<script>
    /* JS Integrado */
    // ‚ö†Ô∏è ¬°REEMPLAZAR CON TU URL REAL DE APPS SCRIPT! (¬°La que termina en /exec!)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOFw5mil7gKDwMv6Zrgi8vESZVMNwcgV1gtOK0nuCcp7OTBDoqRn9WGloIryMNqq-dug/exec'; 
    let allChannels = [];

    function showLoading(isLoading) {
        document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        document.getElementById('exportBtn').disabled = isLoading || allChannels.length === 0;
    }

    // --- M3U Parsing Logic ---
    function parseM3U(m3uContent) {
        const lines = m3uContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const channels = [];
        const categories = new Set();
        const languages = new Set();
        let currentChannel = null;
        let epgFound = false;
        let tvgUrl = null;

        for (const line of lines) {
            if (line.startsWith('#EXTM3U')) {
                const tvgUrlMatch = line.match(/url-tvg="([^"]+)"/i);
                if (tvgUrlMatch) {
                    tvgUrl = tvgUrlMatch[1];
                }
                continue;
            }

            if (line.startsWith('#EXTINF')) {
                if (currentChannel) {
                    currentChannel = null;
                }
                
                const groupTitleMatch = line.match(/group-title="([^"]+)"/i);
                const tvgIDMatch = line.match(/tvg-id="([^"]+)"/i);
                const langMatch = line.match(/tvg-language="([^"]+)"/i);
                const nameMatch = line.match(/,(.*)$/);

                const category = groupTitleMatch ? groupTitleMatch[1] : 'Sin Categor√≠a';
                const name = nameMatch ? nameMatch[1].trim() : 'Canal Desconocido';
                const epgID = tvgIDMatch ? tvgIDMatch[1] : '';
                const language = langMatch ? langMatch[1] : '';

                if (epgID) epgFound = true;
                if (language) languages.add(language);
                categories.add(category);

                currentChannel = {
                    name,
                    category,
                    epgID,
                    url: '',
                    language,
                    tvgUrl: tvgUrl
                };
            } else if (currentChannel && line.startsWith('http')) {
                currentChannel.url = line;
                channels.push(currentChannel);
                currentChannel = null;
            }
        }
        
        const expirationDate = m3uContent.includes('expire') ? 'Detectada (Revisar M3U)' : 'No Detectada';

        return {
            channels,
            categories: [...categories].sort((a, b) => a.localeCompare(b)),
            epgFound,
            languages: [...languages].join(', ') || 'N/A',
            expirationDate
        };
    }

    // --- FUNCI√ìN loadM3U CON MANEJO DE ERRORES DETALLADO ---
    async function loadM3U() {
        showLoading(true);
        allChannels = [];

        const file = document.getElementById('fileInput').files[0];
        const url = document.getElementById('urlInput').value.trim();
        let m3uContent = '';

        try {
            if (file) {
                m3uContent = await file.text();
                document.getElementById('loading').textContent = 'Analizando archivo M3U local...';
            } else if (url) {
                document.getElementById('loading').textContent = 'Solicitando M3U a trav√©s de Google Apps Script...';
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'fetchExternalUrl', url: url }) 
                });

                // 1. Verificar el estado HTTP de la respuesta
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Respuesta fallida de Apps Script (HTTP no OK):", errorText);
                    throw new Error(`Error HTTP: ${response.status}. Revisa el Log del Apps Script.`);
                }

                // 2. Intentar parsear el JSON
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    // Fall√≥ porque la respuesta NO es JSON (probablemente error HTML de Google/script)
                    const rawText = await response.text();
                    console.error("Error al parsear JSON. Respuesta sin formato del script:", rawText);
                    throw new Error("El Apps Script no devolvi√≥ un JSON v√°lido. Revisa el Log del script para errores POST.");
                }
                
                // 3. Verificar el estado de la l√≥gica del script
                if (result.status === 'success') {
                    m3uContent = result.m3uContent;
                } else {
                    // Captura el error de la funci√≥n fetchExternalUrl
                    throw new Error(result.error || 'Fallo desconocido en el Apps Script Proxy.');
                }

            } else {
                alert('Por favor, selecciona un archivo M3U o ingresa una URL.');
                showLoading(false);
                return;
            }

            // Resto de la l√≥gica de an√°lisis...
            const data = parseM3U(m3uContent);
            allChannels = data.channels;

            // ... l√≥gica para mostrar metadatos y categor√≠as...
            document.getElementById('totalChannels').textContent = allChannels.length;
            document.getElementById('epgStatus').textContent = data.epgFound ? 'S√≠' : 'No';
            document.getElementById('expirationDate').textContent = data.expirationDate;
            document.getElementById('languages').textContent = data.languages;
            document.getElementById('metadata').style.display = 'block';
            renderCategories(data.categories);

        } catch (error) {
            console.error('Error al cargar/analizar M3U:', error);
            alert('Error Cr√≠tico: ' + error.message + '. Revise la consola y los Logs de Apps Script.');
        } finally {
            showLoading(false);
            document.getElementById('loading').textContent = '';
        }
    }
    // --- FIN DE loadM3U CORREGIDO ---

    function renderCategories(categories) {
        const list = document.getElementById('categoryList');
        list.innerHTML = ''; // Limpiar lista
        if (categories.length === 0) {
            list.innerHTML = '<p style="color: var(--secondary-text);">No se encontraron categor√≠as.</p>';
            document.getElementById('categoryPlaceholder').style.display = 'block';
            return;
        }

        document.getElementById('categoryPlaceholder').style.display = 'none';

        categories.forEach(category => {
            const item = document.createElement('label');
            item.className = 'category-item';
            item.innerHTML = `
                <input type="checkbox" data-category="${category}" onchange="filterChannels()">
                ${category}
            `;
            list.appendChild(item);
        });
        filterChannels(); // Llama inicialmente para asegurar la tabla vac√≠a o con datos
    }

    function filterChannels() {
        const checkboxes = document.querySelectorAll('#categoryList input[type="checkbox"]:checked');
        const selectedCategories = Array.from(checkboxes).map(cb => cb.dataset.category);
        const channelBody = document.getElementById('channelBody');
        channelBody.innerHTML = '';
        let selectedCount = 0;

        if (selectedCategories.length === 0) {
            document.getElementById('selectedCount').textContent = '0';
            document.getElementById('exportBtn').disabled = true;
            return;
        }

        const filteredChannels = allChannels.filter(c => selectedCategories.includes(c.category));
        selectedCount = filteredChannels.length;

        filteredChannels.forEach(channel => {
            const row = channelBody.insertRow();
            row.innerHTML = `
                <td>${channel.name}</td>
                <td>${channel.epgID || 'N/A'}</td>
                <td>${channel.category}</td>
                <td style="font-size: 0.7em;">${channel.url}</td>
            `;
        });

        document.getElementById('selectedCount').textContent = selectedCount;
        document.getElementById('exportBtn').disabled = selectedCount === 0;
    }

    // --- Export to Sheets Logic ---
    async function exportToSheets() {
        const checkboxes = document.querySelectorAll('#categoryList input[type="checkbox"]:checked');
        const selectedCategories = Array.from(checkboxes).map(cb => cb.dataset.category);

        if (selectedCategories.length === 0) {
            alert('Selecciona al menos una categor√≠a para exportar.');
            return;
        }

        const dataToExport = allChannels
            .filter(c => selectedCategories.includes(c.category))
            .map(c => ({
                Nombre: c.name,
                Categoria: c.category,
                Url: c.url,
                EpgID: c.epgID,
                Idioma: c.language,
                Fuente: document.getElementById('urlInput').value.trim() || 'Archivo Local'
            }));
        
        if (dataToExport.length === 0) {
            alert('No hay canales para exportar en las categor√≠as seleccionadas.');
            return;
        }

        document.getElementById('exportBtn').textContent = 'Exportando...';
        document.getElementById('exportBtn').disabled = true;

        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors', // Necesario para Apps Script
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'appendM3UData', data: dataToExport })
            });

            // Reutilizamos el chequeo HTTP para exportaci√≥n tambi√©n
            if (!response.ok) {
                 const errorText = await response.text();
                 console.error("Respuesta fallida de Apps Script (HTTP no OK) durante exportaci√≥n:", errorText);
                 throw new Error(`Error HTTP: ${response.status}. Revisa el Log del Apps Script.`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                alert(`Exportaci√≥n exitosa. ${result.appendedRows} canales a√±adidos a Google Sheets.`);
            } else {
                throw new Error(result.error || 'Error desconocido al comunicarse con Google Sheets.');
            }

        } catch (error) {
            console.error('Error en la exportaci√≥n a Sheets:', error);
            alert('Error al exportar. Aseg√∫rate de que la URL de Apps Script es correcta y el script est√° desplegado. Detalle: ' + error.message);
        } finally {
            document.getElementById('exportBtn').textContent = 'üì§ Exportar Seleccionados a Google Sheets';
            // Solo re-habilita si hay canales ya cargados
            document.getElementById('exportBtn').disabled = allChannels.length === 0;
        }
    }
    
    // Inicializaci√≥n al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('exportBtn').disabled = true;
    });

</script>
</body>
</html>
